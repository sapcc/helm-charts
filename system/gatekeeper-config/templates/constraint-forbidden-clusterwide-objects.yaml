apiVersion: constraints.gatekeeper.sh/v1beta1
kind: GkForbiddenClusterwideObjects
metadata:
  name: forbiddenclusterwideobjects-dryrun
  annotations:
    {{- include "sources" (tuple "forbidden-clusterwide-objects" "forbidden-clusterwide-objects") | indent 4 }}
    {{- include "docstring" (tuple $ "GkForbiddenClusterwideObjects") | indent 4 }}
  labels:
    severity: 'debug'
spec:
  enforcementAction: dryrun
  match: {{ include "match_webhook_configs" . | indent 4 }}
  parameters:
    allowlist:
      {{- if eq .Values.cluster_type "test" }}
      - kind: ValidatingWebhookConfiguration
        releaseName: foo-operator
        releaseNamespace: foo
      - kind: MutatingWebhookConfiguration
        releaseName: foo-operator
        releaseNamespace: foo
      {{- end }}
      # TODO: Extend: curl -s https://doop-api.global.cloud.sap/v2/violations'?template_kind=GkForbiddenClusterwideObjects'
      - kind: ValidatingWebhookConfiguration
        releaseName: gatekeeper-validating-webhook-configuration
        releaseNamespace: kube-system
      - kind: ValidatingWebhookConfiguration
        releaseName: gatekeeper-validating-webhook-configuration
        releaseNamespace: monsoon3
      {{- if eq .Values.cluster_type "kubernikus" "virtual" "metal" }}
      - kind: ValidatingWebhookConfiguration
        releaseName: kube-system-{{ .Values.cluster_type }}-cert-manager-webhook
        releaseNamespace: kube-system
      - kind: MutatingWebhookConfiguration
        releaseName: kube-system-{{ .Values.cluster_type }}-cert-manager-webhook
        releaseNamespace: kube-system
      {{- else }}
      - kind: ValidatingWebhookConfiguration
        releaseName: kube-system-cert-manager-webhook
        releaseNamespace: kube-system
      - kind: MutatingWebhookConfiguration
        releaseName: kube-system-cert-manager-webhook
        releaseNamespace: kube-system
      {{- end }}
