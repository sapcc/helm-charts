{{- range $key, $cluster := .Values.mgmtShoots }}
---
apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: mgmt-{{ $key }}
  annotations:
    shoot.gardener.cloud/cloud-config-execution-max-delay-seconds: "30" # applies changes to OperatingSystemConfigurations faster
spec:
  cloudProfile:
    kind: CloudProfile
    name: ironcore-metal
  credentialsBindingName: metal-{{ $key }}
  seedName: rt-{{ $key }}
  region: {{ $key }}
  networking:
    pods: {{ default $.Values.networking.pods $cluster.networking.pods }}
    services: {{ default $.Values.networking.services $cluster.networking.services }}
    nodes: {{ default $.Values.networking.nodes $cluster.networking.nodes }}
    type: calico
    providerConfig:
      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
      kind: NetworkConfig
      backend: bird
      vethMTU: "8950"
      ipam:
        type: host-local
        cidr: usePodCIDR
      overlay:
        enabled: false
        createPodRoutes: true
      birdExporter:
        enabled: {{ required ".Values.networking.enableBirdExporter is required" $.Values.networking.enableBirdExporter }}
  kubernetes:
    version: {{ default $.Values.kubernetes.version $cluster.version }}
    kubeAPIServer:
      featureGates:
        AnonymousAuthConfigurableEndpoints: true
      structuredAuthentication:
        configMapName: authentication-config-mgmt
      {{- if $.Values.auditing.enabled }}
      auditConfig:
        auditPolicy:
          configMapRef:
            name: audit-policy-cp
      {{- end }}
    verticalPodAutoscaler:
      enabled: true # VPA needs to enabled for ManagedSeed
  maintenance:
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
  {{- if $.Values.auditing.enabled }}
  extensions:
  - type: auditing
    providerConfig:
      apiVersion: auditing.extensions.gardener.cloud/v1alpha1
      kind: AuditConfiguration
      backends:
      - http:
          url: {{ $.Values.auditing.url }}
          tls:
            secretReferenceName: auditing-mtls-credentials
  {{- end }}
  resources:
  - name: extraignition-mgmt-{{ $key }}
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: extraignition-mgmt-{{ $key }}
  {{- if $.Values.auditing.enabled }}
  - name: auditing-mtls-credentials
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: auditing-mtls-credentials
  {{- end }}
  provider:
    type: ironcore-metal
    infrastructureConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      networks:
      {{- range $cluster.networking.nodeNetworks }}
      - name: nodenetwork-{{ . | replace "/" "-" | replace "." "-" }}
        cidr: {{ . }}
      {{- end }}
    controlPlaneConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      cloudControllerManager:
        networking:
          configureNodeAddresses: true
          ipamKind:
            apiGroup: ipam.cluster.x-k8s.io
            kind: IPAddress
      loadBalancerConfig:
        calicoConfig:
          IPPools:
            {{- range $cluster.networking.externalServices }}
            - cidr: {{ .cidr }}
              assignmentMode: {{ default "Automatic" .assignmentMode }}
            {{- end }}
          calicoBgpConfig:
            asNumber: {{ $cluster.networking.asNumber }}
            bgpPeer:
            {{- range $cluster.networking.bgpPeers }}
            - asNumber: {{ default $cluster.networking.asNumber .asNumber }}
              nodeSelector: {{ .nodeSelector }}
              peerIP: {{ .peerIP }}
  # uncomment after Gardener v1.129.0
  #            filters:
  #            - v4filter
            {{- end }}  
  # uncomment after Gardener v1.129.0
  #          bgpFilter:
  #            - name: v4filter
  #              exportV4:
  #                {{- range $cluster.networking.externalServices }}
  #                - cidr: {{ .cidr }}
  #                  matchOperator: Equal
  #                  action: Reject
  #                {{- end }}
            nodeToNodeMeshEnabled: false
            serviceLoadBalancerIPs:
            {{- range $cluster.networking.externalServices }}
            - {{ .cidr }}
            {{- end }}

    workers:
    {{- range $workerkey, $worker := $cluster.workers }}
      - name: mgmt-{{ $workerkey }}
        machine:
          architecture: amd64
          image:
            name: gardenlinux
            version: {{ default $.Values.imageVersion $cluster.imageVersion }}
          type: baremetal
        minimum: {{ $worker.poolSize }}
        maximum: {{ $worker.poolSize }}
        maxSurge: 0
        maxUnavailable: 1
        zones:
        - {{ $workerkey }}
        machineControllerManager:
          machineCreationTimeout: 1h30m0s
          machineHealthTimeout: 1h0m0s
          machineDrainTimeout: 1h30m0s
        providerConfig:
          apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
          kind: WorkerConfig
          extraServerLabels:
            topology.kubernetes.io/zone: {{ $workerkey }}
            kubernetes.metal.cloud.sap/cluster: mgmt-{{ $key }}
          metadata:
            interfaces: {{ default $.Values.networking.interfaces $cluster.networking.interfaces }}
            vlan: {{ default $.Values.networking.vlan $cluster.networking.vlan | quote }}
            region: {{ $key }}
          ipamConfig:
          - metadataKey: bond
            ipamRef:
              apiGroup: ipam.cluster.x-k8s.io
              kind: GlobalInClusterIPPool
              name: mgmt-{{ $workerkey }}
          extraIgnition:
            override: false
            secretRef: extraignition-mgmt-{{ $key }}
            raw: |
            {{- if $cluster.extraIgnition }}
              {{ $cluster.extraIgnition | nindent 14 }}
            {{- end }}
            {{- if $.Values.extraIgnition }}
              {{ $.Values.extraIgnition | nindent 14 }}
            {{- end }}
    {{- end }}
{{- end }}
