mariadb:
  name: datahubdb
  enabled: true
  dbName: datahub
  image: mariadb:10.4.12
  imagePullPolicy: IfNotPresent
  port_public: 3306
  max_connections: 1024
  buffer_pool_size: "1024M"
  performance_schema: "OFF"
  log_file_size: "256M"
  query_cache_size: "0"
  query_cache_type: "0"
  join_buffer_size: "4M"
  binlog_format: "MIXED"
  expire_logs_days: 10
  initdb_configmap: datahub-initdb
  ronly_user: ronly
  ronly_password: DEFINED-IN-REGION
  livenessProbe:
    enabled: false
  readinessProbe:
    enabled: false
  metrics:
    enabled: true
  persistence_claim:
    name: datahubdb-pvclaim
    enabled: true
    autoprovision:
      enabled: true
  restore:
    enabled: false
    schedule: 10 1 * * *
    image:
      repo: keppel.eu-de-1.cloud.sap/ccloud/go-maria-restore
      tag: DEFINED-IN-PIPELINE
    swift_token: DEFININED-IN-SECRETS
    additional_sql_file: "/config/openstack_view.sql"
    backup_dir: "/backups/"
    read_access: null
    debug:
      enabled: false

ingress:
  disco: true

alerts:
  enabled: false
  prometheus: kubernetes

backup_v2:
  enabled: false

yellowPages:
  enabled: false
  metrics:
    enabled: false
    path: "/metrics"
    port: "9100"
    prometheus: infra-collector
  image: "datahub-yellowpages"
  imageVersion: DEFINED-IN-PIPELINE
  requiredDatabases:
    - "keystone"
    - "nova"
    - "neutron"
    - "glance"
  requiredTables:
    - "datahub.cc_billing"
  views:
    - name: openstack_ips
      definition: "create or replace table datahub.openstack_ips
         ( floating_ip_id varchar(36) NOT NULL,
           primary key ( floating_ip_id ) )
       as
           select  f.floating_ip_address AS floating_ip_address,
                 f.id as floating_ip_id,
                 port.id AS port,p.name AS project,
                 p.id AS project_id,
                 d.name AS domain,
                 n.name AS network,
                 n.id AS network_id,
                 s.name AS subnet,
                 s.id AS subnet_id,
                 sn.name AS subnetpool,
                 sn.id AS subnetpool_id,
                 r.id AS router_id,
                 r.name AS router,
                 fixed_port.device_id as instance_id,
                 fixed_port.device_owner as owner,
                 i.display_name as instance_name,
                 i.host as host,
                 i.availability_zone as availability_zone
                 from neutron.floatingips f
                     left join keystone.project p on f.project_id = p.id
                     left join keystone.project d on p.domain_id = d.id
                     left join neutron.ipallocations ip on f.floating_ip_address = ip.ip_address
                     left join neutron.networks n on f.floating_network_id = n.id
                     left join neutron.subnets s on ip.subnet_id = s.id
                     left join neutron.subnetpools sn on s.subnetpool_id = sn.id
                     left join neutron.ports port on ip.port_id = port.id
                     left join neutron.ports fixed_port on f.fixed_port_id = fixed_port.id
                     left join neutron.routers r on r.id = f.router_id
                     left join datahub.nova_instances i on i.uuid = fixed_port.device_id;"
    - name: openstack_ips2
      definition: "create or replace view datahub.openstack_ips2
          as select  ip.ip_address AS ip_address,
          port.id AS port,
          p.name AS project,
          p.id AS project_id,
          d.name AS domain,
          n.name AS network,
          n.id AS network_id,
          s.name AS subnet,
          s.id AS subnet_id,
          sn.name AS subnetpool,
          sn.id AS subnetpool_id,
          r.id AS router_id,
          r.name AS router,
          port.device_id as instance_id,
          port.device_owner as owner,
          i.display_name as instance_name,
          i.host as host,
          i.availability_zone as availability_zone
          from neutron.ipallocations ip
              left join neutron.ports port on ip.port_id = port.id
              left join keystone.project p on port.project_id = p.id
              left join keystone.project d on p.domain_id = d.id
              left join neutron.networks n on ip.network_id = n.id
              left join neutron.subnets s on ip.subnet_id = s.id
              left join neutron.subnetpools sn on s.subnetpool_id = sn.id
              left join neutron.routerports rp on port.id = rp.port_id
              left join neutron.routers r on r.id = rp.router_id
              left join datahub.nova_instances i on i.uuid = port.device_id;"
    - name: glance_images
      definition: "create or replace table datahub.glance_images
                  ( id varchar(36) NOT NULL,
                    primary key ( id, instance_name, instance_id, created_at ) )
                    as
                    select  g.id AS id,
                          g.name AS name,
                          g.visibility AS visibility,
                          n.display_name as instance_name,
                          n.uuid as instance_id,
                          p.id as project_id,
                          p.name as project_name,
                          d.id as domain_id,
                          d.name as domain_name,
                          n.created_at as created_at,
                          n.image_ref as image_ref
                          from glance.images g
                              left join datahub.nova_instances n on n.image_ref = g.id
                              left join keystone.project p on p.id = n.project_id
                              left join keystone.project d on d.id = p.domain_id where n.uuid is not null;"