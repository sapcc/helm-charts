{{/*
  Constraint objects cannot be included in the Helm manifest directly.
  See templates/configmap-delayed-payloads.yaml and templates/job-apply-delayed-payloads.yaml for details.
*/}}
{{- define "pod-security-v2" -}}

{{/* This check is disabled entirely in the lab clusters to avoid needlessly obstructing the development of changes to the core components. */}}
{{/* In the QA cluster, this check is in audit-only mode. Service owners can set up new deployments there and then ask for an extension of the allowlist based on that template. */}}
{{- if ne .Values.cluster_layer "labs" }}

apiVersion: constraints.gatekeeper.sh/v1beta1
kind: GkPodSecurityV2
metadata:
  name: pod-security-v2
  annotations:
    {{- include "sources" (tuple "pod-security-v2" "pod-security-v2") | indent 4 }}
    {{- include "docstring" (tuple $ "GkPodSecurityV2") | indent 4 }}
  labels:
    severity: 'debug'
spec:
  enforcementAction: dryrun
  match: {{ include "match_pods_and_pod_owners" . | indent 4 }}
  parameters:
    allowlist:

      ##########################################################################
      # Rules used by unit tests (also documents which keys are available)

      {{- if eq .Values.cluster_type "test" }}
      - matchNamespace: foo
        matchRepository: test-app/unprivileged
        justification: |
          This rule is used in unit tests only.
          If represents a pod that requests hardly any special privileges.
        mayUseCapabilities: [ FOO ]

      - matchNamespace: foo
        matchRepository: test-app/highly-privileged
        justification: |
          This rule is used in unit tests only.
          It represents a pod that requests every possible type of privilege.
        mayUseHostNetwork: true
        mayUseHostPID: true
        mayUsePrivilegeEscalation: true
        mayBePrivileged: true
        mayUseCapabilities: [ FOO, SYS_ADMIN ]
        mayReadHostPathVolumes: [ / ]
        mayWriteHostPathVolumes: [ / ]
      {{- end }}

      ##########################################################################
      # Global rules

      - matchNamespace: '*'
        matchRepository: ccloud/servicemesh/proxy-init
        justification: |
          Linkerd adds a sidecar container to each relevant pod in order to connect the pod network to the service mesh.
          CAP_NET_ADMIN is needed to modify network interfaces, routing tables, and packet filter rules.
          CAP_NET_RAW is used to create raw network sockets.
        mayBePrivileged: true
        mayUsePrivilegeEscalation: true
        mayUseCapabilities: [ NET_ADMIN, NET_RAW ]

      ##########################################################################
      # Rules for ci-tooling

      - matchNamespace: concourse
        matchRepository: ccloud-dockerhub-mirror/haproxytech/kubernetes-ingress
        justification: |
          TODO
          Why does Concourse need its own ingress? And why does it need
          CAP_NET_BIND_SERVICE instead of being exposed via a k8s Service?
        mayUseCapabilities: [ NET_BIND_SERVICE ]

      - matchNamespace: concourse
        matchRepository: ccloud-dockerhub-mirror/concourse/concourse
        justification: |
          Concourse worker pods need to access their work directory on the host FS.
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ /concourse-work-dir ]

      {{- if eq .Values.cluster_type "scaleout" }}
      - matchNamespace: workstation
        matchRepository: ccloud-dockerhub-mirror/library/docker
        justification: |
          A Workstation deployment contains a "docker-carrier" container where
          a Docker daemon is running. dockerd needs privileged access to the
          kernel to run, even when localized into a container.
        mayBePrivileged: true
      {{- end }}

      ##########################################################################
      # Rules for infra-monitoring

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace:  infra-monitoring
        matchRepository: ccloud-dockerhub-mirror/cloudprober/cloudprober
        justification: |
          The cloudprober pods need to send pings.
        mayUseCapabilities: [ NET_RAW ]
      {{- end }}

      ##########################################################################
      # Rules for kube-monitoring

      {{- if eq .Values.cluster_type "baremetal" "concourse" "cloudshell" "internet" "scaleout" }}
      - matchNamespace: kube-monitoring
        matchRepository: ccloud-dockerhub-mirror/falcosecurity/falco
        justification: |
          TODO
        mayBePrivileged: true
        mayReadHostPathVolumes: [ /boot, /usr, /etc, /proc ]
        mayWriteHostPathVolumes: [ /lib/modules, /run/containerd, /run/crio, /var/run ]
      {{- end }}

      - matchNamespace: kube-monitoring
        matchRepository: ccloud-dockerhub-mirror/prom/node-exporter
        justification: |
          The node-exporter requires node-level access and needs to inspect the host filesystem
          in order to collect node metrics.
        mayUseHostNetwork: true
        mayUseHostPID: true
        mayReadHostPathVolumes: [ /, /proc, /sys, /var/run/dbus/system_bus_socket ]

      - matchNamespace: kube-monitoring
        matchRepository: ccloud-quay-mirror/brancz/kube-rbac-proxy
        justification: |
          TODO
        mayUseHostNetwork: true
        mayUseHostPID: true

      {{- if eq .Values.cluster_type "baremetal" "cloudshell" "concourse" "internet" "scaleout" }}
      - matchNamespace: kube-monitoring
        matchRepository: ccloud/kubernetes-oomkill-exporter
        justification: |
          The oomkill-exporter needs to talk to container runtimes and read the kernel log.
        mayBePrivileged: true
        mayReadHostPathVolumes: [ /dev/kmsg ]
        mayWriteHostPathVolumes: [ /run/containerd/containerd.sock, /var/run/docker.sock ]
      {{- end }}

      ##########################################################################
      # Rules for kube-network

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: cni-nanny
        matchRepository: ccloud-ghcr-io-mirror/sapcc/cni-nanny
        justification: |
          TODO
        mayUseHostNetwork: true

      - matchNamespace: calico-apiserver
        matchRepository: ccloud-dockerhub-mirror/calico/apiserver
        justification: |
          TODO
        mayUseHostNetwork: true

      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/calico/kube-controllers
        justification: |
          TODO
        mayUseHostNetwork: true
      {{- end }}

      {{- if eq .Values.cluster_type "baremetal" "cloudshell" }}
      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/calico/node
        justification: |
          TODO
        mayUseHostNetwork: true
        mayBePrivileged: true
        mayReadHostPathVolumes: [ /var/log/calico/cni, /proc ]
        mayWriteHostPathVolumes: [ /etc/cni/net.d, /run/xtables.lock, /sys/fs/, /sys/fs/bpf, /var/lib/calico, /var/run/calico, /var/run/nodeagent ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-ghcr-io-mirror/czerwonk/bird_exporter
        justification: |
          TODO
        mayUseHostNetwork: true
        mayReadHostPathVolumes:
        - /var/run/calico

      - matchNamespace: kube-system
        matchRepository: ccloud/kubelet
        justification: |
          TODO
        mayUseHostNetwork: true
      
      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/calico/cni
        justification: |
          Many kube-system components need broad network access (e.g. coredns,
          CNI, ingress-nginx)
        mayBePrivileged: true
        mayUseHostNetwork: true
        mayWriteHostPathVolumes: [ /etc/cni/net.d, /opt/cni/bin ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/calico/typha
        justification: |
          TODO
        mayUseHostNetwork: true
      {{- end }}

      {{- if eq .Values.cluster_type "concourse" "internet" "postfix" "scaleout" }}
      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/flannelcni/flannel
        justification: |
          TODO
        mayUseHostNetwork: true
        mayUseCapabilities: [ NET_ADMIN, NET_RAW ]
        mayWriteHostPathVolumes: [ /run/flannel, /run/xtables.lock, /etc/cni/net.d ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/flannelcni/flannel-cni-plugin
        justification: |
          Many kube-system components need broad network access (e.g. coredns,
          CNI, ingress-nginx)
        mayUseHostNetwork: true
        mayUseCapabilities: [ NET_ADMIN, NET_RAW ]
        mayWriteHostPathVolumes: [ /opt/cni/bin ]
      {{- end }}

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: kube-system
        matchRepository: ccloud/cni-plugins
        justification: |
          Many kube-system components need broad network access (e.g. coredns,
          CNI, ingress-nginx)
        mayUseHostNetwork: true
        mayWriteHostPathVolumes: [ /opt/cni/bin ]

      - matchNamespace: kube-system
        matchRepository: ccloud/multus-cni
        justification: |
          Many kube-system components need broad network access (e.g. coredns,
          CNI, ingress-nginx)
        mayUseHostNetwork: true
        mayWriteHostPathVolumes: [ /opt/cni/bin ]

      - matchNamespace: kube-system
        matchRepository: ccloud/pause-amd64
        justification: |
          Many kube-system components need broad network access (e.g. coredns,
          CNI, ingress-nginx)
        mayUseHostNetwork: true
      {{- end }}

      - matchNamespace: kube-system
        matchRepository: ccloud-registry-k8s-io-mirror/kube-proxy
        justification: |
          Many kube-system components need broad node-level access (e.g.
          kube-proxy, MTU discovery, wormhole to k8s central).
        mayUseHostNetwork: true
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ /run/xtables.lock ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-ghcr-io-mirror/sapcc/kube-parrot
        justification: |
          Many kube-system components need broad node-level access (e.g.
          kube-proxy, MTU discovery, wormhole to k8s central).
        mayUseHostNetwork: true
        mayWriteHostPathVolumes: [ /etc/kubernetes/kube-parrot ]

      - matchNamespace: kube-system
        matchRepository: ccloud/kube-externalip
        justification: |
          Many kube-system components need broad node-level access (e.g.
          kube-proxy, MTU discovery, wormhole to k8s central).
        mayUseHostNetwork: true
        mayBePrivileged: true

      - matchNamespace: kube-system
        matchRepository: ccloud/ip-masq-agent
        justification: |
          Many kube-system components need broad node-level access (e.g.
          kube-proxy, MTU discovery, wormhole to k8s central).
        mayUseHostNetwork: true
        mayUseCapabilities: [ NET_ADMIN, NET_RAW ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud/k8s-conntrack-nanny
        justification: |
          Many kube-system components need broad node-level access (e.g.
          kube-proxy, MTU discovery, wormhole to k8s central).
        mayUseHostNetwork: true
        mayUseCapabilities: [ NET_ADMIN ]

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: default
        matchRepository: ccloud/sporebox
        justification: |
          Sporebox is used to jump into the namespaces of network agents.
        mayUseHostNetwork: true
        mayUseHostPID: true
        mayBePrivileged: true
      {{- end }}

      {{- if eq .Values.cluster_type "scaleout" "internet" }}
      - matchNamespace: tailscale
        matchRepository: ccloud/tailcontrol
        justification: |
          TODO
          Why does Tailscale need to be privileged? Is CAP_NET_ADMIN not enough?
          Tailscale needs CAP_NET_ADMIN to establish its VPN network interface.
        mayBePrivileged: true
        mayUseCapabilities: [ NET_ADMIN ]
      {{- end }}

      - matchNamespace: kube-system
        matchRepository: ccloud/kubernikus
        justification: |
          Many kube-system components need broad node-level access (e.g.
          kube-proxy, MTU discovery, wormhole to k8s central).
        mayUseHostNetwork: true
        mayBePrivileged: true
        mayReadHostPathVolumes: [ /var/lib/kubelet/ ]

      ##########################################################################
      # Rules for kube-system

      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/coredns/coredns
        justification: |
          Many kube-system components need broad network access (e.g. coredns,
          CNI, ingress-nginx)
        mayUseCapabilities: [ NET_BIND_SERVICE ]

      - matchNamespace: kube-system
        matchRepository: ccloud-registry-k8s-io-mirror/provider-os/cinder-csi-plugin
        justification: |
          TODO
        mayUseHostNetwork: true
        mayUsePrivilegeEscalation: true
        mayBePrivileged: true
        mayUseCapabilities: [ SYS_ADMIN ]
        mayWriteHostPathVolumes: [ /dev, /var/lib/kubelet, /var/lib/kubelet/plugins/cinder.csi.openstack.org ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-registry-k8s-io-mirror/sig-storage/livenessprobe
        justification: |
          TODO
        mayUseHostNetwork: true
        mayUsePrivilegeEscalation: true
        mayBePrivileged: true
        mayUseCapabilities: [ SYS_ADMIN ]
        mayWriteHostPathVolumes: [ /var/lib/kubelet/plugins/cinder.csi.openstack.org ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-registry-k8s-io-mirror/sig-storage/csi-node-driver-registrar
        justification: |
          TODO
        mayUseHostNetwork: true
        mayUseCapabilities: [ SYS_ADMIN ]
        mayUsePrivilegeEscalation: true
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ /var/lib/kubelet/plugins/cinder.csi.openstack.org, /var/lib/kubelet/plugins_registry/ ]

      - matchNamespace: maintenance-controller
        matchRepository: ccloud/flatcar-linux-update-operator
        justification: |
          TODO
        mayWriteHostPathVolumes: [ /etc/flatcar, /etc/os-release, /usr/share/flatcar, /var/run/dbus ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud-registry-k8s-io-mirror/ingress-nginx/controller
        justification: |
          TODO
        mayUseCapabilities: [ NET_BIND_SERVICE ]

      {{- if eq .Values.cluster_type "cloudshell" "concourse" "internet" "scaleout" }}
      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/library/alpine
        justification: |
          TODO
        mayBePrivileged: true
        mayUseHostPID: true
        mayWriteHostPathVolumes: [ / ]

      - matchNamespace: kube-system
        matchRepository: ccloud-dockerhub-mirror/sapcc/pause-amd64
        justification: |
          TODO
        mayUseHostPID: true
      {{- end }}

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: kube-system
        matchRepository: ccloud-ghcr-io-mirror/sapcc/ccloud-nodecidr-controller
        justification: |
          TODO
        mayUseHostNetwork: true
      {{- end }}

      - matchNamespace: kube-system
        matchRepository: ccloud-registry-k8s-io-mirror/node-problem-detector/node-problem-detector
        justification: |
          TODO
        mayUseHostNetwork: true
        mayBePrivileged: true
        mayReadHostPathVolumes: [ /etc/localtime, /proc, /var/log/ ]

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: kube-system
        matchRepository: ccloud/iptables
        justification: |
          TODO
        mayUseHostNetwork: true
        mayBePrivileged: true

      - matchNamespace: kube-system
        matchRepository: ccloud-ghcr-io-mirror/sapcc/go-pmtud
        justification: |
          TODO
        mayUseHostNetwork: true
        mayBePrivileged: true
      {{- end }}

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: kube-system
        matchRepository: ccloud/sysctl
        justification: |
          TODO
        mayUseHostNetwork: true
        mayBePrivileged: true
      {{- end }}

      - matchNamespace: kube-system
        matchRepository: ccloud/toolbox-docker
        justification: |
          TODO
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ /etc/sudoers.d/, /opt/bin/, /root, /var/lib, /var/run/docker.sock ]
      
      - matchNamespace: kube-system
        matchRepository: ccloud/toolbox-sleep
        justification: |
          TODO
        mayBePrivileged: true

      ##########################################################################
      # Rules for observability

      - matchNamespace: audit-logs
        matchRepository: ccloud-elastic-mirror/beats/auditbeat-oss
        justification: |
          The "auditbeat" container needs to break out into the host to read
          and also configure the kernel audit log.
        mayUseHostPID: true
        mayUseCapabilities: [ AUDIT_CONTROL, AUDIT_READ, AUDIT_WRITE ]
        mayReadHostPathVolumes: [ /bin, /sbin, /usr/bin, /usr/sbin, /etc, /run/containerd ]
        mayWriteHostPathVolumes: [ /var/lib/auditbeat-data ]

      - matchNamespace: audit-logs
        matchRepository: ccloud/auditbeat-exporter
        justification: |
          The "auditbeat" container needs to break out into the host to read
          and also configure the kernel audit log.
        mayUseHostPID: true
      
      {{- if eq .Values.cluster_type "cloudshell" "concourse" "internet" "scaleout" }}
      - matchNamespace: audit-logs
        matchRepository: ccloud-dockerhub-mirror/library/alpine
        justification: |
          The init container "enable-pamd-tty" needs to break out into the host
          to setup audit logging for PAM-based authentication (this is only
          necessary in clusters where the worker nodes are provisioned by
          OpenStack instead of Terraform).
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ / ]
      {{- end }}

      - matchNamespace: audit-logs
        matchRepository: ccloud/elk-fluent
        justification: |
          Most Fluent pods (except -systemd) need to read container logs.
          All Fluent pods need to access log files on the host.
        mayReadHostPathVolumes: [ /var/lib/docker/containers ]
        mayWriteHostPathVolumes: [ /var/log ]

      {{- if eq .Values.cluster_type "baremetal" "scaleout" }}
      - matchNamespace: logs
        matchRepository: ccloud/elk-fluent
        justification: |
          Most Fluent pods (except -systemd) need to read container logs.
          All Fluent pods need to access log files on the host.
        mayReadHostPathVolumes: [ /var/lib/docker/containers ]
        mayWriteHostPathVolumes: [ /var/log ]
      {{- end }}

      - matchNamespace: logs
        matchRepository: ccloud/opentelemetry-collector-contrib
        justification: |
          Most Otel pods need to access log files on the host.
        mayReadHostPathVolumes: [ /var/log ]

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: hermes
        matchRepository: ccloud-dockerhub-mirror/library/busybox
        justification: |
          Elastic and OpenSearch need to use sysctl to increase `vm.max_map_count`:
          <https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html>
        mayBePrivileged: true
      {{- end }}

      {{- if eq .Values.cluster_type "scaleout" }}
      - matchNamespace: opensearch-logs
        matchRepository: ccloud-dockerhub-mirror/library/busybox
        justification: |
          Elastic and OpenSearch need to use sysctl to increase `vm.max_map_count`:
          <https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html>
        mayBePrivileged: true
      {{- end }}

      ##########################################################################
      # Rules for openstack-compute

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: monsoon3
        matchRepository: ccloud/loci-ironic
        justification: |
          TODO
        mayUseCapabilities: [ NET_ADMIN ]
      {{- end }}

      ##########################################################################
      # Rules for openstack-network

      - matchNamespace: monsoon3
        matchRepository: ccloud/archer
        justification: |
          TODO
        mayBePrivileged: true

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: monsoon3
        matchRepository: ccloud-dockerhub-mirror/library/alpine
        justification: |
          The init container mounts the entire host FS to load kernel modules.
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ / ]
      
      - matchNamespace: monsoon3
        matchRepository: ccloud/loci-neutron
        justification: |
          The agent containers need to reach into most customer networks.
        mayBePrivileged: true
        mayUseCapabilities: [ DAC_OVERRIDE, DAC_READ_SEARCH, NET_ADMIN, SYS_ADMIN, SYS_PTRACE ]
        mayWriteHostPathVolumes: [ /dev/log ]
      {{- end }}

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: ns-exporter
        matchRepository: ccloud/ns-exporter
        justification: |
          The ns-exporter needs to reach into all network namespaces.
        mayBePrivileged: true
        mayUseHostPID: true
      {{- end }}

      ##########################################################################
      # Rules for openstack-storage

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: monsoon3
        matchRepository: ccloud/loci-cinder
        justification: |
          TODO
        mayUseCapabilities: [ CHOWN, DAC_OVERRIDE, DAC_READ_SEARCH, FOWNER, NET_ADMIN, SYS_ADMIN ]
      {{- end }}

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: swift
        matchRepository: ccloud/swift
        justification: |
          Swift storage components inspect the network interfaces to establish
          their identity within the Swift ring and need to be able to 
          mount/unmount disks at runtime.
          All swift components need to access the storage disks (as well as state
          shared with the drive autopilot).
        mayUseHostNetwork: true
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ /run/swift-storage/state, /srv/node, /var/cache/swift ]

      - matchNamespace: swift
        matchRepository: ccloud/swift-rings
        justification: |
          Swift storage components inspect the network interfaces to establish
          their identity within the Swift ring and need to be able to 
          mount/unmount disks at runtime.
          All swift components need to access the storage disks (as well as state
          shared with the drive autopilot).
        mayUseHostNetwork: true
      
      - matchNamespace: swift
        matchRepository: ccloud/swift-drive-autopilot
        justification: |
          Swift-drive-autopilot needs far-reaching access to the host FS to
          find/format/encrypt/decrypt/mount/unmount disks and watch the
          kernel log for errors.
        mayBePrivileged: true
        mayWriteHostPathVolumes: [ / ]

      - matchNamespace: swift
        matchRepository: ccloud-dockerhub-mirror/prom/statsd-exporter
        justification: |
          TODO
        mayUseHostNetwork: true
      {{- end }}

      ##########################################################################
      # Rules for postfix

      {{- if eq .Values.cluster_type "postfix" }}
      - matchNamespace: ingress-nginx
        matchRepository: ingress-nginx/controller
        justification: |
          TODO
        mayUsePrivilegeEscalation: true
        mayUseCapabilities: [ NET_BIND_SERVICE ]

      - matchNamespace: postfixin
        matchRepository: genady/postfix-exporter
        justification: |
          TODO
        mayReadHostPathVolumes: [ /var/log/pods/ ]
      
      - matchNamespace: postfixin-bounce
        matchRepository: genady/postfix-exporter
        justification: |
          TODO
        mayReadHostPathVolumes: [ /var/log/pods/ ]
        
      - matchNamespace: postfixout
        matchRepository: istio/proxyv2
        justification: |
          TODO
        mayUseCapabilities: [ NET_ADMIN, NET_RAW ]
      
      - matchNamespace: postfixout
        matchRepository: genady/postfix-exporter
        justification: |
          TODO
        mayReadHostPathVolumes: [ /var/log/pods/ ]

      - matchNamespace: postfixout-alt
        matchRepository: genady/postfix-exporter
        justification: |
          TODO
        mayReadHostPathVolumes: [ /var/log/pods/ ]
      {{- end }}

      ##########################################################################
      # Rules for px

      {{- if eq .Values.cluster_type "baremetal" }}
      - matchNamespace: px
        matchRepository: ccloud/px
        justification: |
          Bird needs to be able to send and receive BGP announcements.
        mayBePrivileged: true
        mayUseCapabilities: [ NET_ADMIN ]
      {{- end }}

      ##########################################################################
      # End of rules

{{- end }}

{{- end -}}
