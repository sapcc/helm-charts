{{- if .Values.mutatingWebhook.enabled }}
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: {{ include "owner-label-injector.fullname" . }}
  labels:
    {{- include "owner-label-injector.labels" . | nindent 4 }}
  annotations:
    cert-manager.io/inject-ca-from: {{ .Release.Namespace }}/{{ include "owner-label-injector.fullname" . }}
webhooks:
  - admissionReviewVersions:
      - v1
    clientConfig:
      service:
        name: {{ include "owner-label-injector.fullname" . }}
        namespace: {{ .Release.Namespace }}
        path: /mutate-generic
    failurePolicy: Ignore
    matchConditions:
      - name: skip-endpoints
        # Keep: Endpoints (core/v1) are still in scope via apiGroups: [""] but we don't want to mutate them.
        expression: "!(object.kind in ['Endpoints'])"
      - name: skip-events
        # Keep: core/v1 Event is included via apiGroups: [""]; events.k8s.io is excluded. We still skip all Events by kind.
        expression: "object.kind != 'Event'"
  {{ if .Values.staging.enabled }}
    name: owner-label-injector.generic-staging.ccloud
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: In
          values:
            - "{{ .Values.staging.namespace }}"
  {{ else }}
    name: owner-label-injector.generic.ccloud
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - "{{ .Values.staging.namespace }}"
      {{- range $ns := .Values.excludedNamespaces }}
            - {{ $ns }}
      {{- end }}
  {{ end }}
    rules:
      - apiGroups:
          # restrict to common namespaced API groups
          - ""                 # core(v1): Pod, Service, ConfigMap, Secret, PVC
          - apps               # Deployment, StatefulSet, DaemonSet, ReplicaSet
          - batch              # Job, CronJob
          - networking.k8s.io  # Ingress, NetworkPolicy
          - autoscaling        # HPA
        apiVersions:
          - '*'
        operations:
          - CREATE
          - UPDATE
        resources:
          - '*'
        scope: Namespaced # avoid cluster-scoped and CRDs
    sideEffects: NoneOnDryRun
{{- end }}

