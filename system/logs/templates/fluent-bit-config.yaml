{{- if index .Values "fluent-bit" "enabled" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  labels:
    app: fluent-bit-fluent-bit
    release: fluent-bit
data:
  fluent-bit.conf: |-
      [SERVICE]
          Flush        1
          Daemon       Off
          Log_Level    info
          Parsers_File parsers.conf
          Parsers_File parsers_custom.conf
          HTTP_Server  On
          HTTP_Listen  0.0.0.0
          HTTP_Port    {{ index .Values "fluent-bit" "metricsPort" }}
          Health_Check On

      [INPUT]
          Name           systemd
          Path           /var/log/journal
          Tag            systemd.*
          Mem_Buf_Limit  5MB
          Read_From_Tail On
          DB             /var/log/fluent-bit-journal.pos.db
          Strip_Underscores On
          Lowercase On

      [FILTER]
          Name          record_modifier
          Match         systemd.*
          Whitelist_key SYSTEMD_UNIT
          Whitelist_key MESSAGE
          Whitelist_key PID
          Whitelist_key PRIORITY
          Whitelist_key COMM
          Whitelist_key HOSTNAME

      [FILTER]
          Name   modify
          Match  systemd.*
          Rename SYSTEMD_UNIT unit
          Rename MESSAGE log
          Rename PID pid
          Rename PRIORITY priority
          Rename COMM cmd
          Rename HOSTNAME hostname


{{ if index .Values "fluent-bit" "filter" "additionalValues" }}
      [FILTER]
          Name record_modifier
          Match *
{{- range index .Values "fluent-bit" "filter" "additionalValues" }}
          Record {{ .key }} {{ .value }}
{{- end }}
{{- end }}

      [OUTPUT]
          Name  es
          Match *
          Host  {{ index .Values "fluent-bit" "backend" "es" "host" }}
          Port  {{ index .Values "fluent-bit" "backend" "es" "port" }}
          Logstash_Format On
          Replace_Dots On
          Retry_Limit False
          Type  _doc
          Time_Key @timestamp
          Logstash_Prefix {{ index .Values "fluent-bit" "backend" "es" "logstash_prefix" }}
          HTTP_User {{ index .Values "fluent-bit" "backend" "es" "http_user" }}
          HTTP_Passwd {{ index .Values "fluent-bit" "backend" "es" "http_passwd" }}
          tls {{ index .Values "fluent-bit" "backend" "es" "tls" "enabled"}}
          tls.verify {{ index .Values "fluent-bit" "backend" "es" "tls" "verify"}}
          tls.debug {{ index .Values "fluent-bit" "backend" "es" "tls" "debug"}}
{{ if index .Values "fluent-bit" "backend" "opensearch" "enabled" }}
      [OUTPUT]
          Name  opensearch
          Match *
          Host  {{ index .Values "fluent-bit" "backend" "opensearch" "host" }}
          Port  {{ index .Values "fluent-bit" "backend" "opensearch" "port" }}
          Logstash_Format On
          Replace_Dots On
          Logstash_Prefix {{ index .Values "fluent-bit" "backend" "opensearch" "logstash_prefix" }}
          HTTP_User {{ index .Values "fluent-bit" "backend" "opensearch" "http_user" }}
          HTTP_Passwd {{ index .Values "fluent-bit" "backend" "opensearch" "http_passwd" }}
          tls {{ index .Values "fluent-bit" "backend" "opensearch" "tls" "enabled"}}
          tls.verify {{ index .Values "fluent-bit" "backend" "opensearch" "tls" "verify"}}
          tls.debug {{ index .Values "fluent-bit" "backend" "opensearch" "tls" "debug"}}
{{- end }}
  parsers.conf: ""
{{- end }}
