{{- if .Values.kvmShoots -}}
{{- range $key, $cluster := .Values.kvmShoots }}
---
apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: {{ $key }}
  labels:
    cluster-type: sci-k8s-compute
    greenhouse.sap/owned-by: compute
    greenhouse.sap/shoot-grafter-transport: {{ default "greenhouse-prod-sci" $.Values.greenhouseShootGrafter }}
    metadata.greenhouse.sap/region: {{ coalesce $.Values.contextSuffix $cluster.region }}
spec:
  cloudProfile:
    kind: CloudProfile
    name: ironcore-metal
  credentialsBindingName: metal-{{ $cluster.region | default $.Values.global.region }}
  region: {{ $cluster.region | default $.Values.global.region }}
  {{- if $cluster.seedSelector }}
  seedSelector: {{- toYaml $cluster.seedSelector | nindent 4 }}
  {{- end }}
  networking:
    pods: {{ default $.Values.networking.pods $cluster.networking.pods }}
    services: {{ default $.Values.networking.services $cluster.networking.services }}
    nodes: {{ $cluster.networking.nodes }}
    type: calico
    providerConfig:
      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
      kind: NetworkConfig
      backend: bird
      vethMTU: "8950"
      ipam:
        type: host-local
        cidr: usePodCIDR
      overlay:
        enabled: false
        createPodRoutes: true
      birdExporter:
        enabled: {{ required ".Values.networking.enableBirdExporter is required" $.Values.networking.enableBirdExporter }}
  kubernetes:
    version: {{ default $.Values.kubernetes.version $cluster.version }}
    kubeAPIServer:
      featureGates:
        AnonymousAuthConfigurableEndpoints: true
      structuredAuthentication:
        configMapName: authentication-config-compute
      {{- if $cluster.auditing.enabled }}
      auditConfig:
        auditPolicy:
          configMapRef:
            name: audit-policy-cp
      {{- end }}
    verticalPodAutoscaler:
      enabled: false
  {{- if $cluster.auditing.enabled }}
  extensions:
  - type: auditing
    providerConfig:
      apiVersion: auditing.extensions.gardener.cloud/v1alpha1
      kind: AuditConfiguration
      backends:
      - http:
          url: {{ $cluster.auditing.url }}
          tls:
            secretReferenceName: auditing-mtls
  resources:
  - name: auditing-mtls
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: auditing-mtls
  {{- end }}
  maintenance:
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
  provider:
    type: ironcore-metal
    infrastructureConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      networks:
      {{- if kindIs "slice" $cluster.networking.nodes }}
      {{- range $cluster.networking.nodes }}
      - name: nodenetwork-{{ . | replace "/" "-" | replace "." "-" }}
        cidr: {{ . }}
      {{- end }}
      {{- else if $cluster.networking.nodes }}
      - name: nodenetwork-{{ $cluster.networking.nodes | replace "/" "-" | replace "." "-" }}
        cidr: {{ $cluster.networking.nodes }}
      {{- end }}
    controlPlaneConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      nodeNamePolicy: "BMCName"
      cloudControllerManager:
        networking:
          configureNodeAddresses: true
          ipamKind:
            apiGroup: ipam.cluster.x-k8s.io
            kind: IPAddress
      loadBalancerConfig:
        calicoConfig:
          IPPools:
            {{- range $cluster.networking.externalServices }}
            - cidr: {{ .cidr }}
              assignmentMode: {{ default "Automatic" .assignmentMode }}
            {{- end }}
          calicoBgpConfig:
            asNumber: {{ $cluster.networking.asNumber }}
            bgpPeer:
            {{- range $cluster.networking.bgpPeers }}
            - asNumber: {{ default $cluster.networking.asNumber .asNumber }}
              nodeSelector: {{ .nodeSelector }}
              peerIP: {{ .peerIP }}
              filters:
              - v4filter
            {{- end }}
            bgpFilter:
              - name: v4filter
                exportV4:
                  {{- range $cluster.networking.externalServices }}
                  - cidr: {{ .cidr }}
                    matchOperator: Equal
                    action: Reject
                  {{- end }}
            nodeToNodeMeshEnabled: false
            serviceLoadBalancerIPs:
            {{- range $cluster.networking.externalServices }}
            - {{ .cidr }}
            {{- end }}
    workers:
    {{- range $workerkey, $worker := $cluster.workers }}
      - name: {{ $workerkey }}
        machine:
          architecture: amd64
          image:
            name: gardenlinux
            version: {{ coalesce $worker.imageVersion $cluster.imageVersion $.Values.imageVersion }}
          type: baremetal
        minimum: {{ $worker.poolSize }}
        maximum: {{ $worker.poolSize }}
        maxSurge: 0
        maxUnavailable: {{ default 1 $worker.maxUnavailable }}
        zones:
        {{- toYaml $worker.zones | nindent 8 }}
        machineControllerManager:
          machineCreationTimeout: 1h20m0s
          machineHealthTimeout: 1h0m0s
          machineDrainTimeout: {{ default "240h0m0s" $worker.machineDrainTimeout }}
        sysctls:
          vm.hugetlb_shm_group: "64055"
          vm.unprivileged_userfaultfd: "1"
        {{- if $worker.labels }}
        labels:
          {{- toYaml $worker.labels | nindent 10 }}
        {{- end }}  
        {{- if $worker.annotations }}
        annotations:
          {{- toYaml $worker.annotations | nindent 10 }}
        {{- end }}  
        providerConfig:
          apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
          kind: WorkerConfig
          extraServerLabels:
            kubernetes.metal.cloud.sap/bb: {{ required "worker.bb is required" $worker.bb }}
            kubernetes.metal.cloud.sap/cluster: {{ $key }}
          metadata:
            interfaces: {{ coalesce $worker.interfaces $cluster.networking.interfaces $.Values.networking.interfaces }}
            vlan: {{ default $.Values.networking.vlan $cluster.networking.vlan | quote }}
            region: {{ $cluster.region | default $.Values.global.region }}
          ipamConfig:
          - metadataKey: bond
            ipamRef:
              apiGroup: ipam.cluster.x-k8s.io
              kind: GlobalInClusterIPPool
              name: compute-{{ $key }}
          extraIgnition:
            override: false
            secretRef: extraignition-compute-{{ $key }}
            raw: |
              storage:
                files:

                {{- if eq (default "stable" $worker.feature) "green" }}
                - path: /etc/default/openvswitch-switch
                  filesystem: root
                  mode: 0644
                  overwrite: true
                  contents:
                    inline: |
                      OVS_CTL_OPTS="--ovs-user='root:openvswitch'"
                {{- end }}

                - path: /etc/polkit-1/rules.d/00-kvm-node-agent.rules
                  overwrite: true
                  mode: 0644
                  contents:
                    inline: |
                      // Allow kvm-node-agent to manage specific service units;
                      // fall back to implicit authorization otherwise.

                      const units = ["libvirtd", "virt-admin"];
                      polkit.addRule(function(action, subject) {
                          if (action.id == "org.freedesktop.systemd1.manage-units" &&
                          subject.user == "kvm-node-agent" &&
                          units.filter(function (unit) { return action.lookup("unit").startsWith(unit) }).length ) {
                              return polkit.Result.YES;
                          }
                      });

                - path: /etc/systemd/logind.conf.d/00-inhibit-delay-10min.conf
                  overwrite: yes
                  mode: 0644
                  contents:
                    inline: |
                      [Login]
                      # Set the maximum delay for the inhibit delay to 10 minutes
                      # to give enough time to emergency evacuate the node
                      InhibitDelayMaxSec=600

                - path: /etc/multipath.conf
                  overwrite: yes
                  mode: 0644
                  contents:
                    inline: |
                      defaults {
                        user_friendly_names         no
                        find_multipaths             yes
                        prio                        "alua"
                        path_grouping_policy        group_by_prio
                        path_selector               "historical-service-time 0"
                        failback                    immediate
                        no_path_retry               1
                        retain_attached_hw_handler  yes
                      }

                      blacklist {
                        protocol scsi:sas
                        protocol scsi:ata
                        protocol nvme:pcie
                      }

                      devices {
                        device {
                          vendor              "NETAPP"
                          product             "*"
                          hardware_handler    "1 alua"
                        }
                      }

                - path: /opt/persist/hugepages.env
                  overwrite: yes
                  mode: 0644
                  contents:
                    inline: |
                      ENABLE_HUGEPAGE_SETUP=true

                - path: /etc/libvirt/libvirt.conf
                  overwrite: yes
                  mode: 0644
                  contents:
                    inline: |
                      {{- if eq (default "stable" $worker.feature) "qemu" }}
                      uri_default = "qemu:///system"
                      {{- else }}
                      uri_default = "ch:///system"
                      {{- end }}

                - path: /etc/libvirt/libvirtd.conf
                  overwrite: yes
                  mode: 0600
                  contents:
                    inline: ""

                {{- if contains "qa" $.Values.global.region }}
                - path: /etc/systemd/coredump.conf.d/90-qa.conf
                  overwrite: yes
                  mode: 0600
                  contents:
                    inline: |
                      [Coredump]
                      Storage=external
                      Compress=yes
                      ExternalSizeMax=32G

                - path: /etc/systemd/system.conf.d/90-qa.conf
                  overwrite: yes
                  mode: 0600
                  contents:
                    inline: |
                      [Manager]
                      DefaultLimitCORE=
                {{- end}}

              systemd:
                units:
                - name: ovsdb-server.service
                  dropins:
                    - name: allow-group.conf
                      contents: |
                        [Service]
                        UMask=0002
                        RuntimeDirectoryMode=0775

                - name: libvirtd.service
                  dropins:
                    - name: want-tls-socket.conf
                      contents: |
                        [Unit]
                        Wants=libvirtd-tls.socket
                        After=libvirtd-tls.socket
                    - name: tls-cert-condition.conf
                      contents: |
                        [Unit]
                        ConditionPathExists=/etc/pki/libvirt/clientcert.pem
                        ConditionPathExists=/etc/pki/libvirt/private/clientkey.pem
                        {{- if eq (default "stable" $worker.feature) "qemu" }}
                        ConditionPathExists=/etc/pki/qemu/client-cert.pem
                        ConditionPathExists=/etc/pki/qemu/client-key.pem
                        {{- end }}

                - name: libvirtd.socket
                  dropins:
                    - name: no-trigger-limit.conf
                      contents: |
                        [Socket]
                        TriggerLimitIntervalSec=0
                    - name: require-tls-certs.conf
                      contents: |
                        [Unit]
                        ConditionPathExists=/etc/pki/libvirt/clientcert.pem
                        ConditionPathExists=/etc/pki/libvirt/private/clientkey.pem
                        {{- if eq (default "stable" $worker.feature) "qemu" }}
                        ConditionPathExists=/etc/pki/qemu/client-cert.pem
                        ConditionPathExists=/etc/pki/qemu/client-key.pem
                        {{- end }}

                - name: libvirtd-tls.socket
                  dropins:
                    - name: require-tls-certs.conf
                      contents: |
                        [Unit]
                        ConditionPathExists=/etc/pki/libvirt/clientcert.pem
                        ConditionPathExists=/etc/pki/libvirt/private/clientkey.pem
                        {{- if eq (default "stable" $worker.feature) "qemu" }}
                        ConditionPathExists=/etc/pki/qemu/client-cert.pem
                        ConditionPathExists=/etc/pki/qemu/client-key.pem
                        {{- end }}

                - name: libvirtd-tcp.socket
                  mask: true

                - name: virt-admin-server-update-tls.service
                  enabled: false
                  contents: |
                    [Unit]
                    Description=Run virt-admin server-update-tls
                    Documentation=man:virt-admin(1)
                    Wants=libvirtd.service
                    After=libvirtd.service
                    ConditionVirtualization=!container
                    ConditionPathExists=/etc/pki/libvirt/clientcert.pem
                    ConditionPathExists=/etc/pki/libvirt/private/clientkey.pem
                    {{- if eq (default "stable" $worker.feature) "qemu" }}
                    ConditionPathExists=/etc/pki/qemu/client-cert.pem
                    ConditionPathExists=/etc/pki/qemu/client-key.pem
                    {{- end }}

                    [Service]
                    Type=oneshot
                    ExecStart=/usr/bin/virt-admin server-update-tls --server libvirtd

                - name: ovs-br-ex.service
                  enabled: true
                  contents: |
                    [Unit]
                    Description=Create OVS bridge for external network
                    DefaultDependencies=no
                    Wants=ovsdb-server.service
                    Wants=ovs-vswitchd.service
                    After=ovsdb-server.service
                    After=ovs-vswitchd.service
                    Before=network-online.target
                    PartOf=network.target

                    [Service]
                    Type=oneshot
                    ExecStart=/usr/bin/ovs-vsctl -- --may-exist add-br br-ex
                    ExecStartPost=-/usr/bin/ip link set br-ex up
                    RemainAfterExit=yes
                    TimeoutSec=0
                    StandardOutput=journal

                    [Install]
                    WantedBy=default.target
    {{- end }}
{{- end }}
{{- end }}
