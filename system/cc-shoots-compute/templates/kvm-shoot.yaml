{{- if .Values.kvmShoots -}}
{{- range $key, $cluster := .Values.kvmShoots }}
---
apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: {{ $key }}
  namespace: garden-ccloud
spec:
  cloudProfile:
    kind: CloudProfile
    name: ironcore-metal
  credentialsBindingName: metal-{{ $cluster.region | default $.Values.global.region }}
  region: {{ $cluster.region | default $.Values.global.region }}
  networking:
    pods: {{ default $.Values.networking.pods $cluster.networking.pods }}
    services: {{ default $.Values.networking.services $cluster.networking.services }}
    nodes: {{ $cluster.networking.nodes }}
    type: calico
    providerConfig:
      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
      kind: NetworkConfig
      backend: bird
      vethMTU: "8950"
      ipam:
        type: host-local
        cidr: usePodCIDR
      overlay:
        enabled: false
        createPodRoutes: true
      birdExporter:
        enabled: {{ required ".Values.networking.enableBirdExporter is required" $.Values.networking.enableBirdExporter }}
  kubernetes:
    version: {{ default $.Values.kubernetes.version $cluster.version }}
    kubeAPIServer:
      featureGates:
        AnonymousAuthConfigurableEndpoints: true
      structuredAuthentication:
        configMapName: authentication-config-compute
      {{- if $cluster.auditing.enabled }}
      auditConfig:
        auditPolicy:
          configMapRef:
            name: audit-policy-cp
      {{- end }}
    verticalPodAutoscaler:
      enabled: false
  {{- if $cluster.auditing.enabled }}
  extensions:
  - type: auditing
    providerConfig:
      apiVersion: auditing.extensions.gardener.cloud/v1alpha1
      kind: AuditConfiguration
      backends:
      - http:
          url: {{ $cluster.auditing.url }}
          tls:
            secretReferenceName: auditing-mtls
  resources:
  - name: auditing-mtls
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: auditing-mtls
  {{- end }}
  maintenance:
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
  provider:
    type: ironcore-metal
    infrastructureConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      networks:
      {{- if kindIs "slice" $cluster.networking.nodes }}
      {{- range $cluster.networking.nodes }}
      - name: nodenetwork-{{ . | replace "/" "-" | replace "." "-" }}
        cidr: {{ . }}
      {{- end }}
      {{- else if $cluster.networking.nodes }}
      - name: nodenetwork-{{ $cluster.networking.nodes | replace "/" "-" | replace "." "-" }}
        cidr: {{ $cluster.networking.nodes }}
      {{- end }}
    controlPlaneConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      nodeNamePolicy: "BMCName"
      cloudControllerManager:
        networking:
          configureNodeAddresses: true
          ipamKind:
            apiGroup: ipam.cluster.x-k8s.io
            kind: IPAddress
      loadBalancerConfig:
        calicoConfig:
          IPPools:
            {{- range $cluster.networking.externalServices }}
            - cidr: {{ .cidr }}
              assignmentMode: {{ default "Automatic" .assignmentMode }}
            {{- end }}
          calicoBgpConfig:
            asNumber: {{ $cluster.networking.asNumber }}
            bgpPeer:
            {{- range $cluster.networking.bgpPeers }}
            - asNumber: {{ default $cluster.networking.asNumber .asNumber }}
              nodeSelector: {{ .nodeSelector }}
              peerIP: {{ .peerIP }}
              filters:
              - v4filter
            {{- end }}
            bgpFilter:
              - name: v4filter
                exportV4:
                  {{- range $cluster.networking.externalServices }}
                  - cidr: {{ .cidr }}
                    matchOperator: Equal
                    action: Reject
                  {{- end }}
            nodeToNodeMeshEnabled: false
            serviceLoadBalancerIPs:
            {{- range $cluster.networking.externalServices }}
            - {{ .cidr }}
            {{- end }}
    workers:
      {{- toYaml $cluster.workers | nindent 6 }}
  {{- if $cluster.seedSelector }}
  seedSelector: {{- toYaml $cluster.seedSelector | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}
