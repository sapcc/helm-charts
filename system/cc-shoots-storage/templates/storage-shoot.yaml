{{- range $key, $cluster := .Values.stShoots }}
{{- $region := regexReplaceAll "^st[0-9]+-" $key "" }}
---
apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: {{ $key }}
spec:
  cloudProfile:
    kind: CloudProfile
    name: ironcore-metal
  credentialsBindingName: metal-{{ $region }}
  seedName: mgmt-{{ $region }}
  region: {{ $key }}
  networking:
    pods: {{ default $.Values.networking.pods $cluster.networking.pods }}
    services: {{ default $.Values.networking.services $cluster.networking.services }}
    nodes: {{ default $.Values.networking.nodes $cluster.networking.nodes }}
    type: calico
    providerConfig:
      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
      kind: NetworkConfig
      backend: bird
      vethMTU: "8950"
      ipam:
        type: host-local
        cidr: usePodCIDR
      overlay:
        enabled: false
        createPodRoutes: true
      birdExporter:
        enabled: {{ required ".Values.networking.enableBirdExporter is required" $.Values.networking.enableBirdExporter }}
      multus:
        enabled: {{ default true (($cluster.networking.multus).enabled) }}
        installCNIPlugins: {{ default true (($cluster.networking.multus).installCNIPlugins) }}
  kubernetes:
    version: {{ default $.Values.kubernetes.version $cluster.version }}
    kubeAPIServer:
      featureGates:
        AnonymousAuthConfigurableEndpoints: true
      structuredAuthentication:
        configMapName: authentication-config-storage
      {{- if $.Values.auditing.enabled }}
      auditConfig:
        auditPolicy:
          configMapRef:
            name: audit-policy-storage
      {{- end }}
    verticalPodAutoscaler:
      enabled: true
  maintenance:
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
  {{- if $.Values.auditing.enabled }}
  extensions:
  - type: auditing
    providerConfig:
      apiVersion: auditing.extensions.gardener.cloud/v1alpha1
      kind: AuditConfiguration
      backends:
      - http:
          url: {{ $.Values.auditing.url }}
          tls:
            secretReferenceName: auditing-mtls-credentials
  {{- end }}
  resources:
  - name: extraignition-storage-{{ $key }}
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: extraignition-storage-{{ $key }}
  {{- if $.Values.auditing.enabled }}
  - name: auditing-mtls-credentials
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: auditing-mtls-credentials
  {{- end }}
  provider:
    type: ironcore-metal
    infrastructureConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      networks:
      {{- range $cluster.networking.nodeNetworks }}
      - name: nodenetwork-{{ . | replace "/" "-" | replace "." "-" }}
        cidr: {{ . }}
      {{- end }}
    controlPlaneConfig:
      apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      cloudControllerManager:
        networking:
          configureNodeAddresses: true
          ipamKind:
            apiGroup: ipam.cluster.x-k8s.io
            kind: IPAddress
      loadBalancerConfig:
        calicoConfig:
          IPPools:
            {{- range $cluster.networking.externalServices }}
            - cidr: {{ .cidr }}
              assignmentMode: {{ default "Automatic" .assignmentMode }}
            {{- end }}
          calicoBgpConfig:
            asNumber: {{ $cluster.networking.asNumber }}
            bgpPeer:
            {{- range $cluster.networking.bgpPeers }}
            - asNumber: {{ default $cluster.networking.asNumber .asNumber }}
              nodeSelector: {{ .nodeSelector }}
              peerIP: {{ .peerIP }}
              filters:
              - v4filter
            {{- end }}
            bgpFilter:
              - name: v4filter
                exportV4:
                  {{- range $cluster.networking.externalServices }}
                  - cidr: {{ .cidr }}
                    matchOperator: Equal
                    action: Reject
                  {{- end }}
            nodeToNodeMeshEnabled: false
            serviceLoadBalancerIPs:
            {{- range $cluster.networking.externalServices }}
            - {{ .cidr }}
            {{- end }}

    workers:
    {{- range $workerkey, $worker := $cluster.workersMonitor }}
      - name: mon-{{ $workerkey }}
        machine:
          architecture: amd64
          image:
            name: gardenlinux
            version: {{ default $.Values.imageVersion $cluster.imageVersion }}
          type: baremetal
        minimum: {{ $worker.poolSize }}
        maximum: {{ $worker.poolSize }}
        maxSurge: 0
        maxUnavailable: 1
        zones:
        - {{ $workerkey }}
        machineControllerManager:
          machineCreationTimeout: 1h30m0s
          machineHealthTimeout: 1h0m0s
          machineDrainTimeout: 1h30m0s
        providerConfig:
          apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
          kind: WorkerConfig
          extraServerLabels:
            topology.kubernetes.io/zone: {{ $workerkey }}
            kubernetes.metal.cloud.sap/cluster: {{ $key }}
            kubernetes.metal.cloud.sap/role: ceph-mon
          metadata:
            interfaces: {{ default $.Values.networking.interfaces $cluster.networking.interfaces }}
            vlan: {{ default $.Values.networking.vlan $cluster.networking.vlan | quote }}
            region: {{ $region }}
          ipamConfig:
          - metadataKey: bond
            ipamRef:
              apiGroup: ipam.cluster.x-k8s.io
              kind: GlobalInClusterIPPool
              name: st-{{ $workerkey }}
          extraIgnition:
            override: false
            secretRef: extraignition-storage-{{ $key }}
            raw: |
            {{- if $cluster.extraIgnition }}
              {{ $cluster.extraIgnition | nindent 14 }}
            {{- end }}
            {{- if $.Values.extraIgnition }}
              {{ $.Values.extraIgnition | nindent 14 }}
            {{- end }}
    {{- end }}
    {{- range $workerkey, $worker := $cluster.workersOSD }}
      - name: osd-{{ $workerkey }}
        machine:
          architecture: amd64
          image:
            name: gardenlinux
            version: {{ default $.Values.imageVersion $cluster.imageVersion }}
          type: baremetal
        minimum: {{ $worker.poolSize }}
        maximum: {{ $worker.poolSize }}
        maxSurge: 0
        maxUnavailable: 1
        zones:
        - {{ $workerkey }}
        machineControllerManager:
          machineCreationTimeout: 1h30m0s
          machineHealthTimeout: 1h0m0s
          machineDrainTimeout: 1h30m0s
        providerConfig:
          apiVersion: ironcore-metal.provider.extensions.gardener.cloud/v1alpha1
          kind: WorkerConfig
          extraServerLabels:
            topology.kubernetes.io/zone: {{ $workerkey }}
            kubernetes.metal.cloud.sap/cluster: {{ $key }}
            kubernetes.metal.cloud.sap/role: ceph-osd
          metadata:
            interfaces: {{ default $.Values.networking.interfaces $cluster.networking.interfaces }}
            vlan: {{ default $.Values.networking.vlan $cluster.networking.vlan | quote }}
            region: {{ $region }}
          ipamConfig:
          - metadataKey: bond
            ipamRef:
              apiGroup: ipam.cluster.x-k8s.io
              kind: GlobalInClusterIPPool
              name: st-{{ $workerkey }}
          extraIgnition:
            override: false
            secretRef: extraignition-storage-{{ $key }}
            raw: |
            {{- if $cluster.extraIgnition }}
              {{ $cluster.extraIgnition | nindent 14 }}
            {{- end }}
            {{- if $.Values.extraIgnition }}
              {{ $.Values.extraIgnition | nindent 14 }}
            {{- end }}
    {{- end }}
{{- end }}
