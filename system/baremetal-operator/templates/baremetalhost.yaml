{{- range $key, $host := .Values.hosts }}
---
apiVersion: v1
kind: Secret
metadata:
  name: networkdata-{{ $key }}
  namespace: {{ $.Release.namespace }}
type: infrastructure.cluster.x-k8s.io/secret
stringData: 
  networkData: |-
    networks:
    - id: {{ $host.vlan }}
      ip_address: {{ $host.ip }}
      link: {{ default "bond0" $host.bond }}
      netmask: {{ default "255.255.255.0" $host.netmask }}
      routes:
      - gateway: {{ $host.gateway }}
        netmask: 0.0.0.0
        network: 0.0.0.0
      type: ipv4
---
apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  name: {{ $key }}
  namespace: {{ $.Release.namespace }}
  labels:
    kubernetes.metal.cloud.sap/name: {{ $key }}
    kubernetes.metal.cloud.sap/bb: {{ $host.bb }}
    kubernetes.metal.cloud.sap/type: {{ default "metal" $host.type }}
    kubernetes.metal.cloud.sap/az: {{ $host.az }}
    kubernetes.metal.cloud.sap/flavor: {{ $host.flavor }}
spec:
  online: {{ default "true" $host.online }}
  bmc:
    address: {{ $host.redfishUrl }}
    credentialsName: bmc-secret-{{ $key }}
    disableCertificateVerification: {{ default "True" $host.disableCertificateVerification }}
  bootMACAddress: {{ $host.bootMac }}
  networkData: 
    name: networkdata-{{ $key }}
    namespace: {{ $.Release.namespace }}
  {{- with $host.rootDeviceHints }}
  rootDeviceHints:
{{- toYaml . | nindent 4 }}
  {{- end }}
---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: bmc-secret-{{ $key }}
  namespace: {{ $.Release.namespace }}
data:
  username: {{ default $.Values.remoteboard.username $host.username | b64enc }}
  password: {{ default $.Values.remoteboard.password $host.password | b64enc }}
{{- end }}
