apiVersion: greenhouse.sap/v1alpha1
kind: PluginPreset
metadata:
  name: thanos-ruler-gardener
  namespace: ccloud
  labels:
    greenhouse.sap/owned-by: observability
{{- if .Values.global.fluxEnabled }}
    greenhouse.sap/deployment-tool: "flux"
  annotations:
    "greenhouse.sap/propagate-labels": "greenhouse.sap/owned-by,greenhouse.sap/deployment-tool"
{{- else }}
  annotations:
    "greenhouse.sap/propagate-labels": "greenhouse.sap/owned-by"
{{- end }}
spec:
  clusterSelector:
    matchExpressions:
    - key: greenhouse.sap/pluginpreset
      operator: In
      values:
      - "true"
    - key: cluster
      operator: In
      values:
        - a-qa-de-200
  plugin:
    displayName: Thanos Ruler Gardener
    pluginDefinition: thanos
    releaseNamespace: kube-monitoring
    optionValues:
    {{- if and .Values.global.quayIoMirror .Values.global.ghcrIoMirror .Values.global.dockerHubMirror }}
    - name: thanos.image.repository
      value: {{ printf "%s/thanos/thanos" .Values.global.quayIoMirror }}
    - name: thanos.initChownData.image.registry
      value: {{ .Values.global.dockerHubMirror }}
    - name: testFramework.image.registry
      value: {{ .Values.global.ghcrIoMirror }}
    {{- end }}
    - name: thanos.ruler.enabled
      value: true
    - name: thanos.query.enabled
      value: false
    - name: thanos.compactor.enabled
      value: false
    - name: thanos.store.enabled
      value: false
    - name: thanos.ruler.alertmanagers.enabled
      value: true
    - name: thanos.ruler.alertmanagers.authentication.ssoCert
      valueFrom:
        secret:
          key: tls.crt
          name: {{ .Chart.Name }}-prometheus-sso-cert
    - name: thanos.ruler.alertmanagers.authentication.ssoKey
      valueFrom:
        secret:
          key: tls.key
          name: {{ .Chart.Name }}-prometheus-sso-cert
    - name: thanos.ruler.alertmanagers.hosts
      value:
        - alertmanager.scaleout.eu-de-1.cloud.sap
        - alertmanager.scaleout.eu-nl-1.cloud.sap
    - name: thanos.ruler.ruleSelector
      value:
        resources.gardener.cloud/managed-by: gardener
    - name: thanos.ruler.alertRelabelConfigs
      value:
        - source_labels: [support_group]
          target_label: support_group
          replacement: containers
          action: replace
        - source_labels: [playbook]
          target_label: playbook
          replacement: https://operations.global.cloud.sap/docs/container/kubernetes/gardener/
          action: replace
