{{- if and .Values.pluginPreset.enabled .Values.cephOperations.enabled }}
apiVersion: greenhouse.sap/v1alpha1
kind: PluginPreset
metadata:
  name: ceph-operations
  namespace: {{ .Release.Namespace }}
  labels:
    greenhouse.sap/owned-by: storage
{{- if .Values.global.fluxEnabled }}
    greenhouse.sap/deployment-tool: "flux"
  annotations:
    "greenhouse.sap/propagate-labels": "greenhouse.sap/owned-by,greenhouse.sap/deployment-tool"
{{- else }}
  annotations:
    "greenhouse.sap/propagate-labels": "greenhouse.sap/owned-by"
{{- end }}
spec:
{{- with .Values.cephOperations.clusterOptionOverrides }}
  clusterOptionOverrides:
    {{ toYaml . | nindent 4 }}
{{- end }}
  clusterSelector:
    matchLabels:
      greenhouse.sap/pluginpreset: "true"
      cluster-type: "storage"
  plugin:
    pluginDefinitionRef:
      kind: PluginDefinition
      name:  ceph-operations
    releaseNamespace: rook-ceph
    deletionPolicy: Retain
    optionValues:
      - name: prometheusRules.ruleSelectors
        value:
          - name: plugin
            value: 'kube-monitoring'
      - name: prometheusRules.additionalRuleLabels
        value:
          # service: ceph      # clashes with the same explicitly specified in ceph-operations chart 
          support_group: storage
{{- end -}}
