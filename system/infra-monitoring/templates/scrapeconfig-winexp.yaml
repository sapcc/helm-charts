{{- $values := .Values.windows_exporter -}}
{{- if $values.enabled }}
{{- $name := "win-exporter-ad" }}
apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: {{ $name}}
  namespace: infra-monitoring
  labels:
    prometheus: {{ .Values.prometheus_infra_collector.name }}
    app.kubernetes.io/name: {{ $name}}
spec:
  httpSDConfigs:
    - url: {{ .Values.http_sd_configs.netbox_production_url }}/virtual-machines/?custom_labels=job={{ $name }}&target=primary_ip&status=active&tenant_id=1&platform=windows-server&tag=active-directory-domain-controller&region={{ .Values.global.region }}
      refreshInterval: {{ .Values.http_sd_configs.refresh_interval }}
{{- if $values.basic_auth.enabled }}
  basicAuth:
     username:
       key: username
       name: jumpserver-node-exporter-auth
     password:
       key: password 
       name: jumpserver-node-exporter-auth
{{- end }}
  metricsPath: /metrics
  scheme: {{ $values.scheme }}
  scrapeInterval: {{$values.scrapeInterval}}
  scrapeTimeout: {{$values.scrapeTimeout}}
  relabelings:
    - sourceLabels: [__address__]
      replacement: $1:{{$values.listen_port}}
      targetLabel: __address__
    - sourceLabels: [name]
      targetLabel: server_name
    - regex: 'name|state'
      action: labeldrop
  metricRelabelings:
    - sourceLabels: [__name__]
      regex: '^go_.+'
      action: drop
    - sourceLabels: ['__name__','exported_name']
      regex: 'windows_service_state;(.*)'
      replacement: '$1'
      targetLabel: 'service_name'
    - sourceLabels: ['__name__','exported_state']
      regex: 'windows_service_state;(.*)'
      replacement: '$1'
      targetLabel: 'service_state'
{{- end }}