apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: jumpserver
  namespace: infra-monitoring
  labels:
    prometheus: {{ .Values.prometheus_infra_collector.name }}
    app.kubernetes.io/name: jumpserver
spec:
  httpSDConfigs:
    - url: {{ .Values.http_sd_configs.netbox_production_url }}/virtual-machines/?custom_labels=job=jumpserver&target=primary_ip&obj_types=virtualization.virtualmachine&tenant=converged-cloud&platform=vmware-esxi&q=jump&region={{ .Values.global.region }}
      refresh_interval: {{ .Values.http_sd_configs.refresh_interval }}
  metrics_path: /metrics
  scrapeInterval: 60s
  scrapeTimeout: 50s
  relabel_configs:
    - source_labels: [job]
      regex: jumpserver
      action: keep
    - source_labels: [__address__]
      target_label: __address__
      regex: '(.*)'
      replacement: $1:9100
    - soure_labels: [name]
      target_label: server_name
    - soure_labels: [exported_name]
      target_label: name
  metric_relabel_configs:
    - regex: "server_id|platform|cluster_type|cluster|cluster_group|site"
      action: labeldrop
