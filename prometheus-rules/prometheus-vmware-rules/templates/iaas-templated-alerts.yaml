groups:
- name: iaas.templated.alerts
  rules:

  {{- $alertLevels := list
        (dict "for" "30m" "severity" "warning")
        (dict "for" "90m" "severity" "critical")
  }}

  {{- range $level := $alertLevels }}
    - alert: IaasVmOnNonIaasHost{{ $level.severity | title }}
      expr: |
        count by (hostsystem) (
          (
            group by (project, hostsystem, virtualmachine)(vrops_virtualmachine_system_powered_on{}==1)
            and on(project)
            group by(project) (label_replace(limes_project_usage{domain=~"iaas-.*"}, "project", "$1", "project_id", "(.*)"))
          )
        )
        and on(hostsystem) vrops_hostsystem_hostgroups{hostgroups!~".*iaas.*"}
      for: {{ $level.for }}
      labels:
        severity: {{$level.severity}}
        service: compute
        support_group: iaas-support
        context: "IaaS vm on non IaaS cluster"
        meta: "IaaS virtual machine(s) running on Non IaaS ESXi host {{ `{{ $labels.hostsystem }}` }}"
      annotations:
        description: "IaaS virtual machine(s) running on non IaaS ESXi host {{ `{{ $labels.hostsystem }}` }}"
        summary: "IaaS virtual machine(s) running on non IaaS ESXi host {{ `{{ $labels.hostsystem }}` }}"
  {{- end }}
