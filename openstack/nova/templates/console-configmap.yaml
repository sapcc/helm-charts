{{- define "console-serial.conf" }}
{{- $cellName := index . 1 }}
{{- $config := index . 2 }}
{{- with index . 0 }}
  {{- if $config.enabled }}
[serial_console]
# nova-serialproxy
serialproxy_port = {{ $config.portInternal }}
# nova-compute
enabled = {{ $config.enabled }}
base_url = https://{{include "nova_console_endpoint_host_public" .}}:{{ .Values.global.novaConsolePortPublic }}/{{ $cellName }}/serial
proxyclient_address = $my_ip
  {{- end }}
{{- end }}
{{- end }}

{{- define "console-novnc.conf" }}
{{- $cellName := index . 1 }}
{{- $config := index . 2 }}
{{- with index . 0 }}
[vnc]
enabled = {{ $config.enabled }}
  {{- if $config.enabled }}
server_listen = $my_ip
server_proxyclient_address = $my_ip
novncproxy_base_url = https://{{include "nova_console_endpoint_host_public" .}}:{{ .Values.global.novaConsolePortPublic }}/{{ $cellName }}/novnc/vnc_auto.html?path=/{{ $cellName }}/novnc/websockify
novncproxy_host = 0.0.0.0
novncproxy_port = {{ $config.portInternal }}
  {{- end }}
{{- end }}
{{- end }}

{{- define "console-mks.conf" }}
{{- $cellName := index . 1 }}
{{- $config := index . 2 }}
{{- with index . 0 }}
[mks]
enabled = {{ $config.enabled }}
  {{- if $config.enabled }}
mksproxy_base_url = https://{{include "nova_console_endpoint_host_public" .}}:{{.Values.global.novaConsolePortPublic}}/{{ $cellName }}/mks/vnc_auto.html?path={{ $cellName }}/mks/websockify
  {{- end }}
{{- end }}
{{- end }}

{{- define "console-shellinabox.conf" }}
{{- $cellName := index . 1 }}
{{- $config := index . 2 }}
{{- with index . 0 }}
[shellinabox]
enabled = {{ $config.enabled }}
  {{- if $config.enabled }}
host = 0.0.0.0
port = {{ $config.portInternal }}
base_url = https://{{include "nova_console_endpoint_host_public" .}}:{{ .Values.global.novaConsolePortPublic }}/{{ $cellName }}/shellinabox
proxyclient_url = https://{{include "ironic_console_endpoint_host_public" .}}
  {{- end }}
{{- end }}
{{- end }}

{{- define "console-spice.conf" }}
{{- $cellName := index . 1 }}
{{- $config := index . 2 }}
{{- with index . 0 }}
[spice]
enabled = {{ $config.enabled }}
  {{- if $config.enabled }}
html5proxy_base_url = https://{{include "nova_console_endpoint_host_public" .}}:{{.Values.global.novaConsolePortPublic}}/{{ $cellName }}/spicehtml5/spice_auto.html
  {{- end }}
{{- end }}
{{- end }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: nova-console
  labels:
    system: openstack
    type: configuration
    component: nova

data:
{{- $envAll := . }}
{{- range $cellId := include "nova.helpers.cell_ids_nonzero" . | fromJsonArray }}
  {{- $cellName := include "nova.helpers.cell_name" (tuple $envAll $cellId) }}
  {{- range $type, $config := $envAll.Values.consoles }}
  console-{{ $cellName }}-{{ $type }}.conf: |
    {{- tuple $envAll $cellName $config | include (print "console-" $type ".conf") | indent 4 }}
  {{ end }}
{{- end }}
