{{- $hypervisor := merge .Values.defaults.hypervisor.kvm .Values.defaults.hypervisor.common }}
kind: DaemonSet
apiVersion: apps/v1
metadata:
  name: neutron-openvswitch-agent
  labels:
    system: openstack
    type: backend
    component: neutron
spec:
  revisionHistoryLimit: {{ .Values.pod.lifecycle.upgrades.deployments.revision_history }}
  selector:
    matchLabels:
      name: neutron-openvswitch-agent
  template:
    metadata:
      labels:
        {{- tuple . "neutron" "openvswitch-agent" | include "helm-toolkit.snippets.kubernetes_metadata_labels" | nindent 8 }}
        name: neutron-openvswitch-agent
        alert-tier: os
        alert-service: neutron
        hypervisor: "kvm"
      annotations:
        configmap-etc-hash: {{ include (print $.Template.BasePath "/configmap-etc.yaml") . | sha256sum }}
    spec:
      hostNetwork: true
      hostPID: true
      hostIPC: true
      hostAliases:
      {{- range $ip := .Values.rabbitmq.externalIPs }}
      - ip: {{ $ip }}
        hostnames:
        - {{ default "rabbitmq" $.Values.rabbitmq.nameOverride | printf "neutron-%s" | trunc 63 | replace "_" "-" | trimSuffix "-" }}
      {{- end }}
      tolerations:
      {{- range $k, $v :=  $hypervisor.pod.tolerations }}
      - # {{ $k }}
      {{- toYaml $v | nindent 8 }}
      {{- end }}
      nodeSelector:
      {{- range $k, $v := $hypervisor.pod.nodeSelector }}
        {{ $k }}: {{ $v }}
      {{- end }}
      initContainers:
      - name: network-from-netbox
        image: {{ required ".Values.global.registry is missing" .Values.global.registry }}/loci-neutron:{{ .Values.imageVersion | required "Please set imageVersion similar" }}
        command: ["/container.init/network-from-netbox"]
        workingDir: "/etc/neutron/neutron.conf.d"
        volumeMounts:
          - mountPath: /container.init
            name: bin
          - mountPath: /etc/neutron
            name: etcneutron
          - mountPath: /etc/neutron/neutron.conf.d
            name: etcneutronconfd
          - mountPath: /etc/neutron/neutron.conf.d/segment-names.yaml
            name: etc-vpod
            subPath: segment-names.yaml
      containers:
        - name: neutron-openvswitch-agent
          image: {{ required ".Values.global.registry is missing" .Values.global.registry }}/loci-neutron:{{ .Values.imageVersion | required "Please set imageVersion or similar" }}
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          command:
          - neutron-openvswitch-agent
          volumeMounts:
          - mountPath: /etc/neutron
            name: etcneutron
          - mountPath: /etc/neutron/neutron.conf.d
            name: etcneutronconfd
          - mountPath: /etc/neutron/neutron.conf
            name: etc
            subPath: neutron.conf
          - mountPath: /etc/neutron/logging.ini
            name: etc
            subPath: logging.ini
          - mountPath: /etc/neutron/rootwrap.conf
            name: etc
            subPath: rootwrap.conf
          - mountPath: /etc/neutron/neutron.conf.d/ml2.conf
            name: etc
            subPath: ml2-conf.conf
          - mountPath: /etc/neutron/neutron.conf.d/vpod.conf
            name: etc-vpod
            subPath: vpod.conf
          - mountPath: /etc/sudoers
            name: etc
            subPath: sudoers
          - mountPath: /run
            name: run
          - mountPath: /lib/modules
            name: modules
            readOnly: true
{{- if not .Values.ovsOnHost }}
        - name: ovsdb-server
          image: {{ required ".Values.global.registry is missing" .Values.global.registry }}/loci-neutron:{{ .Values.imageVersion | required "Please set .imageVersion" }}
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          command:
          - start-ovsdb-server
          env:
          volumeMounts:
          - mountPath: /run
            name: run
          - mountPath: /usr/local/bin
            name: bin
        - name: ovs-vswitchd
          image: {{ required ".Values.global.registry is missing" .Values.global.registry }}/loci-neutron:{{ .Values.imageVersion | required "Please set imageVersion or similar" }}
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          command:
          - start-ovs-vswitchd
          volumeMounts:
          - mountPath: /run
            name: run
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /usr/local/bin
            name: bin
{{- end }}
      dnsConfig:
        searches:
          - {{ .Values.global.region }}.{{ .Values.global.tld }}
      volumes:
      - name: run
        hostPath:
          path: /run
      - name: etcneutron
        emptyDir:
          medium: Memory
      - name: etcneutronconfd
        emptyDir:
          medium: Memory
      - name: modules
        hostPath:
          path: /lib/modules
      - name: etc
        configMap:
          name: {{ .Release.Name }}-etc
      - name: etc-vpod
        configMap:
          name: {{ .Release.Name }}-etc-vpod
      - name: bin
        configMap:
          name: {{ .Release.Name }}-bin
          defaultMode: 0755
