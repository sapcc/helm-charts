#!/var/lib/openstack/bin/python3
from pathlib import Path
import platform
import textwrap
import uuid

import requests
import yaml

def get_hostname():
    node = platform.node().split(".", 1)[0]
    # Is the hostname already matching our pattern
    if not node.startswith("shoot--"):
        return node

    try:
        mac = uuid.getnode()
        query = f'{{ interface_list(filters: {{mac_address: "{mac:012x}"}}) {{ device {{ name }} }} }}'

        response = requests.post(
            "https://netbox.global.cloud.sap/graphql/", json={"query": query}
        )

        response.raise_for_status()
        json = response.json()
        name = json['data']['interface_list'][0]['device']['name'].split(".", 1)[0]
        return "kvm-" + name
    except (IndexError, KeyError):
        return node


def get_network(hostname):
    with open('neutron.conf.d/segment-names.yaml', 'r') as f:
        segments = yaml.safe_load(f)
        for segment_name, hosts in segments.items():
            if hostname in hosts:
                return segment_name
        else:
            return hostname.rsplit("-", 1)[-1]


if __name__ == '__main__':
    hostname = get_hostname()
    network_name = get_network(hostname)

    ovs = Path('neutron-openvswitch-agent.conf.d')
    if ovs.is_dir():
        ovs = ovs / 'ovs.conf'
        ovs.write_text(textwrap.dedent(f"""\
            [DEFAULT]
            host={hostname}
        
            [OVS]
            bridge_mappings={network_name}:br-ex
            
            [securitygroup]
            firewall_driver = openvswitch
        """))

    linuxbridge = Path('neutron-linuxbridge-agent.conf.d')
    if linuxbridge.is_dir():
        linuxbridge = linuxbridge / 'linuxbridge.conf'
        linuxbridge.write_text(textwrap.dedent(f"""\
            [DEFAULT]
            host={hostname}
        
            [LINUX_BRIDGE]
            physical_interface_mappings={network_name}:bond0
            
            [securitygroup]
            firewall_driver = iptables
        """))
