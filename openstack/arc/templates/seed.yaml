{{- $cdomains := .Values.global.domain_seeds.customer_domains | required "missing value for .Values.global.domain_seeds.customer_domains" -}}
{{- $domains  := concat (list "ccadmin" "cc3test") $cdomains -}}
{{- $cdomainsWithoutSupportProjects := .Values.global.domain_seeds.customer_domains_without_support_projects | required "missing value for .Values.global.domain_seeds.customer_domains_without_support_projects" -}}

apiVersion: "openstack.stable.sap.cc/v1"
kind: "OpenstackSeed"
metadata:
  name: arc-seed
  labels:
    app: {{ template "fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
spec:
  requires:
    requires:
      {{- range $domains}}
      {{- if not (hasPrefix "iaas-" .)}}
    - monsoon3/domain-{{replace "_" "-" . | lower}}-seed
      {{- end }}
      {{- end }}
  services:
    - name: Arc
      type: arc
      description: 'Arc remote execution service'
      endpoints:
      - interface: public
        region: '{{.Values.region}}'
        url: 'https://arc.{{.Values.region}}.cloud.sap'
  roles:
  - name: automation_admin
  - name: automation_viewer

  # cc3test gets special handling
  # ccadmin gets additional role assignments for projects and some group assignments
  # iaas- is excluded

  domains:
  - name: cc3test
    groups:
    - name: CC3TEST_API_SUPPORT
      role_assignments:
      - domain: cc3test
        role: automation_admin
        inherited: true

  {{- range $domains }}
  {{- if and (ne . "cc3test") (not (hasPrefix "iaas-" .))}}
  - name: {{ . }}
    {{- if and $.Values.updatesProxy.createContainers (eq . "ccadmin")}}
    projects:
    - name: master
      swift:
        enabled: true
        containers:
        {{- range $channel := $.Values.updatesProxy.channels  }}
        - name: {{ $channel.container }}
          metadata:
            meta-web-listings: 'true'
            read: .r:*,.rlistings
        {{- end }}
    {{- end }}
    groups:
    - name: {{ hasPrefix "iaas-" . | ternary . ( upper . ) }}_API_SUPPORT
      role_assignments:
      - domain: {{ . }}
        role: automation_admin
        inherited: true
    - name: {{ hasPrefix "iaas-" . | ternary . ( upper . ) }}_COMPUTE_SUPPORT
      role_assignments:
      - domain: {{ . }}
        role: automation_viewer
        inherited: true
    - name: {{ hasPrefix "iaas-" . | ternary . ( upper . ) }}_NETWORK_SUPPORT
      role_assignments:
      - domain: {{ . }}
        role: automation_viewer
        inherited: true
    - name: {{ hasPrefix "iaas-" . | ternary . ( upper . ) }}_STORAGE_SUPPORT
      role_assignments:
      - domain: {{ . }}
        role: automation_viewer
        inherited: true
    - name: {{ hasPrefix "iaas-" . | ternary . ( upper . ) }}_SERVICE_DESK
      role_assignments:
      - domain: {{ . }}
        role: automation_viewer
        inherited: true
  {{- end }}
  {{- end }}
