{{- define "designatenanny.secretstemplate" }}
{{- /*

      This template is used for the in-region and out-of region nanny, see end of file for the include calls

 */}}
{{- $name := .Nanny.nanny }}
{{- $nanny := index .Values .Nanny.nanny }}
{{- $nanny_users := required (printf "No users defined in '%s'" $name ) (index $nanny "users") }}
{{- $openstack_user := required (printf "no openstack user defined in '%s'" $name ) (index $nanny_users "openstack") }}
{{- $openstack_creds := index .Values.users $openstack_user }}
---
kind: Secret
apiVersion: v1
metadata:
  name: {{ .Nanny.release }}-openstack-secret
  labels:
    ccloud/support-group: network-api
    system: openstack
    application: designate
data:
  os_username: "{{ required ( printf "missing username in openstack user '%s'" $openstack_user ) $openstack_creds.username | b64enc}}"
  os_password: "{{ required ( printf "missing password in openstack user '%s'" $openstack_user ) $openstack_creds.password | b64enc}}"

{{- if hasKey $nanny_users "swift" }}
{{- $swift_user := required ( printf "no openstack user defined in '%s'" $name ) ( index $nanny_users "swift" ) }}
{{- $swift_creds := index .Values.users $swift_user }}
---
kind: Secret
apiVersion: v1
metadata:
  name: {{ .Nanny.release }}-swift-secret
  labels:
    ccloud/support-group: network-api
    system: openstack
    application: designate
data:
  os_username: "{{ required ( printf "missing username in swift user '%s'" $swift_user ) $swift_creds.username | b64enc}}"
  os_password: "{{ required ( printf "missing password in swift user '%s'" $swift_user ) $swift_creds.password | b64enc}}"
{{- end }}
{{- end }}
{{- /*


  Below we include the 'template' above conditionally for our nanny and the out-of-region nanny.

  To supply parameters to the include, we merge the 'Nanny' dictionary into the global namespace.


*/}}
{{- if .Values.nanny_enabled }}
{{- $release := printf "%s" .Release.Name }}
{{- $Nanny := dict "nanny" "designate_nanny" "release" $release }}
{{- include "designatenanny.secretstemplate" (merge (dict "Nanny" $Nanny) . ) -}}
{{- end }}

{{- if .Values.nanny_oor_enabled }}
{{- $release := printf "%s-oor" .Release.Name }}
{{- $Nanny := dict "nanny" "designate_nanny_oor" "release" $release }}
{{- include "designatenanny.secretstemplate" (merge (dict "Nanny" $Nanny) . ) -}}
{{- end }}
