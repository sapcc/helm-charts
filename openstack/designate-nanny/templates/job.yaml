{{- if .Values.nanny.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
 name: designate-nanny-{{ .Release.Revision }}
 labels:
    ccloud/support-group: network-api
    system: openstack
    application: designate
spec:
 backoffLimit: 0
 template:
   metadata:
     name: designate-nanny-{{ .Release.Revision }}
   spec:
     restartPolicy: Never
     containers:
     - name: job
       image: {{ required ".Values.global.registry is missing" .Values.global.registry }}/{{ .Values.image.name }}:{{required "missing .Values.image.image_tag" .Values.image.image_tag }}
       command: ["/opt/venv/bin/designate-nanny", "--config", "/srv/nanny.yaml", "autorun"]
       env:
         - name: OS_AUTH_URL
           value: "https://{{ include "keystone_api_endpoint_host_public" . }}/v3"
         - name: PYCCLOUD_USE_DUMMY_SECRETS
           value: "yes"          
         - name: OS_REGION_NAME
           value: "{{.Values.global.region}}"
         - name: OS_PROJECT_NAME
           value:  "{{ .Values.credentials.designate_api.project_name}}"
         - name: OS_PROJECT_DOMAIN_NAME
           value:  "{{ .Values.credentials.designate_api.project_domain_name}}"
         - name: OS_USERNAME
           value: "{{ .Values.credentials.designate_api.user}}"
         - name: OS_PASSWORD
           valueFrom:
             secretKeyRef:
               name: designate-nanny-secret
               key:  designate_nanny_os_password
         - name: OS_USER_DOMAIN_NAME
           value:  "{{ .Values.credentials.designate_api.project_user_domain_name}}"
       resources:
{{ toYaml .Values.resources | indent 8 }}
       volumeMounts:
       - mountPath: /srv/nanny.yaml
         name: nanny-conf
         subPath: nanny.yaml

       - mountPath: /srv/bind1/var/lib/bind
         name: bind1-persistent-storage
       - mountPath: /srv/bind1/etc/bind/rndc.key
         name: bind1-keys-rndc
         subPath: rndc.key
       - mountPath: /srv/bind1/etc/bind/tsig.key
         name: bind1-keys-tsig
         subPath: tsig.key
       - mountPath: /srv/bind2/var/lib/bind
         name: bind2-persistent-storage
       - mountPath: /srv/bind2/etc/bind/rndc.key
         name: bind2-keys-rndc
         subPath: rndc.key
       - mountPath: /srv/bind2/etc/bind/tsig.key
         name: bind2-keys-tsig
         subPath: tsig.key



     volumes:
     - name: bind1-persistent-storage
       persistentVolumeClaim:
         claimName: bind1-{{.Values.global.region}}
     - configMap:
         defaultMode: 420
         items:
         - key: rndc.key
           path: rndc.key
         name: bind1-{{.Values.global.region}}-keys
       name: bind1-keys-rndc
     - configMap:
         defaultMode: 420
         items:
         - key: tsig.key
           path: tsig.key
         name: bind1-{{.Values.global.region}}-keys
       name: bind1-keys-tsig

     - name: bind2-persistent-storage
       persistentVolumeClaim:
         claimName: bind2-{{.Values.global.region}}
     - configMap:
         defaultMode: 420
         items:
         - key: rndc.key
           path: rndc.key
         name: bind2-{{.Values.global.region}}-keys
       name: bind2-keys-rndc
     - configMap:
         defaultMode: 420
         items:
         - key: tsig.key
           path: tsig.key
         name: bind2-{{.Values.global.region}}-keys
       name: bind2-keys-tsig


{{- end }}
