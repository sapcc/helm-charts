{{- if .Values.maia.enabled }}
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: maia
  namespace: maia
  labels:
    system: openstack
    service: metrics

spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        component: maia
      annotations:
        checksum/maia-templates-maia-configmap.yaml: {{ include "maia/templates/maia-configmap.yaml" . | sha256sum }}
    spec:
      nodeSelector:
        zone: farm
      volumes:
        - name: maia-etc
          configMap:
            name: maia
      containers:
        - name: maia
          # remove the "$" prefix which is used to prevent helm's --set option from reformatting plain numbers into floats in scientific notation
          image: "{{ .Values.global.image_registry }}/monsoon/maia:{{ .Values.maia.image_version | replace "$" "" }}"
          imagePullPolicy: IfNotPresent
#          command: ["sh"]
#          args:
#            - -c
#            - "ls /etc/maia; sleep 10000"
          args: ["serve"]
          volumeMounts:
            - mountPath: /etc/maia
              name: maia-etc
          ports:
            - name: api
              containerPort: {{ .Values.maia.listen_port }}
{{- end }}
