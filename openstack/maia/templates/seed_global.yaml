{{- if .Values.global.is_global_region }}
apiVersion: "openstack.stable.sap.cc/v1"
kind: "OpenstackSeed"
metadata:
  name: maia-seed
  labels:
    component: maia
spec:
  requires:
  - {{ .Values.global.globalKeystoneNamespace }}/keystone-global-seed

  roles:
  - name: monitoring_viewer
  - name: monitoring_admin

  services:
  # register Maia in the global OpenStack service catalog
  - name: maia
    type: metrics
    description: Expose Prometheus metrics as multi-tenant OpenStack service
    enabled: true
    endpoints:
    - region: {{.Values.global.region}}
      interface: public
      enabled: true
      url: '{{.Values.maia_global.endpoint_protocol_public | default "https"}}://{{.Values.maia_global.endpoint_host_public}}:{{.Values.maia_global.endpoint_port_public | default "443"}}'

  domains:
  # seed technical service user
  - name: {{.Values.maia.service_user.user_domain_name}}
    users:
    - name: {{.Values.maia.service_user.name}}
      description: 'Maia API User'
      password: {{ .Values.maia.service_user.password | quote }}
      role_assignments:
      - project: {{.Values.maia.service_user.project_name}}
        role: service
    - name: admin
      role_assignments:
      - domain: Default
        role: monitoring_viewer
      - project: admin
        role: monitoring_viewer
    groups:
    - name: administrators
      role_assignments:
      - domain: Default
        role: monitoring_viewer
      - project: admin
        role: monitoring_viewer

  # Grant monitoring roles to ccadmin groups that exist in global
  - name: ccadmin
    groups:
    - name: CCADMIN_CLOUD_ADMINS
      role_assignments:
      - project: cloud_admin
        role: monitoring_viewer
    - name: CCADMIN_DOMAIN_RESOURCE_ADMINS
      role_assignments:
      - domain: ccadmin
        role: monitoring_viewer

  # Grant monitoring roles to global domain groups
  - name: global
    groups:
    - name: GLOBAL_API_SUPPORT
      role_assignments:
      - domain: global
        role: monitoring_viewer
        inherited: true
    - name: GLOBAL_DOMAIN_ADMINS
      role_assignments:
      - domain: global
        role: monitoring_viewer
      - project: admin
        role: monitoring_viewer
    - name: GLOBAL_DOMAIN_RESOURCE_ADMINS
      role_assignments:
      - domain: global
        role: monitoring_viewer
{{- end }}
