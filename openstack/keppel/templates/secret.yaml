{{- $vbase  := .Values.global.vaultBaseURL | required "missing value for .Values.global.vaultBaseURL" -}}
{{- $region := .Values.global.region       | required "missing value for .Values.global.region"       -}}

{{- $leader_region := (index .Values.keppel.peer_groups .Values.keppel.peer_group).leader -}}

{{- $overrides := merge (dict) (index $.Values.keppel.region_overrides $region | default (dict)) $.Values.keppel.region_overrides.default }}
{{- $trivy_region := $overrides.trivy_region | default $region -}}

{{- $rabbituser := "notifications-default" -}}
{{- if eq $region "qa-de-1" -}}
  {{- $rabbituser = "notifications-keppel" -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: keppel-secret
data:
  service_user_password: {{ printf "%s/%s/keppel/keystone-user/service/password" $vbase $region             | b64enc }}
  rabbitmq_username:     {{ printf "%s/%s/hermes/rabbitmq-user/%s/user"          $vbase $region $rabbituser | b64enc }}
  rabbitmq_password:     {{ printf "%s/%s/hermes/rabbitmq-user/%s/password"      $vbase $region $rabbituser | b64enc }}
  federation_service_user_password: {{ printf "%s/%s/keppel/keystone-user/service/password" $vbase $leader_region | b64enc }}
  trivy_token: {{ printf "%s/s-%s/trivy/trivy-token/default/token" $vbase $trivy_region | b64enc }}
