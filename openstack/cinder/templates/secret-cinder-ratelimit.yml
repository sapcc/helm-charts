{{- define "cinder.api.ratelimit-secret" -}}
{{- $type := index . 1 -}}
{{- $conf := index . 2 -}}
{{- with index . 0 -}}
{{- if $conf.rate_limit.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: cinder-api-{{ $type }}-ratelimit-secret
  labels:
    system: openstack
    application: {{ .Release.Name }}
type: Opaque
data:
  {{- $key := printf "api-%s-ratelimit-redis" $type }}
  ratelimit-backend-secret.conf: {{ required (printf "Rate Limit Middleware for %s requires a Backend Password" $type) (index .Values $key "redisPassword") | b64enc | quote }}
{{- end }}
{{- end }}
{{- end }}

{{- include "cinder.api.ratelimit-secret" (tuple . "external" .Values.api_external) }}
---
{{ include "cinder.api.ratelimit-secret" (tuple . "internal" .Values.api_internal) }}
