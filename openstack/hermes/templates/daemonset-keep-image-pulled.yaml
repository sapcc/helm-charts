{{- if not (.Values.global.region | hasPrefix "qa-") }}

# Because Keppel and Keystone depend on Hermes and the other way around the Docker images
# for Hermes should be pre-pulled to able to start in case keppel is down.
# This daemonset (through its existence) keeps required images permanently
# pulled on all nodes.
#
# The condition above skips this daemonset on QA and lab regions, because high
# availability is not a concern there. By omitting the daemonset there, the
# Helm deployment will finish faster since it does not have to wait on it.
# This also avoids wasting resources in small lab clusters.

kind: DaemonSet
apiVersion: apps/v1

metadata:
  name: {{ .Release.Name }}-keep-image-pulled
  annotations:
    # This pod intentionally has extremely tight resource requests.
    # The VerticalPodAutoscaler should never waste resources by increasing those.
    vpa-butler.cloud.sap/update-mode: "Off"

spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 5
  selector:
    matchLabels:
      app: {{ .Release.Name }}-keep-image-pulled
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-keep-image-pulled
        alert-tier: os
        alert-service: hermes
      annotations:
        linkerd.io/inject: disabled # This pod does not interact with the network.
    spec:
      containers:
        - name: hermes-rabbitmq
          image: {{ required ".Values.global.dockerHubMirrorAlternateRegion is missing" .Values.global.dockerHubMirrorAlternateRegion }}/{{ .Values.rabbitmq_notifications.image }}:{{ required ".Values.rabbitmq_notifications.imageTag is missing" .Values.rabbitmq_notifications.imageTag }}
          imagePullPolicy: IfNotPresent
          command: [ '/bin/sleep', 'inf' ]
          resources:
            requests:
              cpu: "1m"
              memory: "20Mi"
            limits:
              cpu: "1m"
              memory: "20Mi"
      terminationGracePeriodSeconds: 1

{{- end }}
