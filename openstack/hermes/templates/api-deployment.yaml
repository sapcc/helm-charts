kind: Deployment
apiVersion: apps/v1

metadata:
  name: hermes-api
  namespace: hermes

spec:
  replicas: 1
  selector:
    matchLabels:
      name: hermes-api
  template:
    metadata:
      labels:
        name: hermes-api
      annotations:
        checksum: {{ include "hermes/templates/api-configmap.yaml" $ | sha256sum }}
    spec:
      nodeSelector:
        zone: farm

      containers:
      - name: api
        image: {{required ".Values.hermes.image is missing" .Values.hermes.image}}:{{.Values.hermes.image_tag}}
        imagePullPolicy: {{required ".Values.hermes.image_pull_policy is missing" .Values.hermes.image_pull_policy}}
        env:
        - name: HERMES_DEBUG
          value: '{{.Values.hermes.debug}}'
        - name: HERMES_ES_URL
          value: "https://{{.Values.hermes_elasticsearch_host}}.{{.Values.global.region}}.{{.Values.global.tld}}:{{.Values.hermes_elasticsearch_port}}"
        - name: HERMES_ES_USERNAME
          valueFrom:
            secretKeyRef:
              name: hermes-es-api
              key: HERMES_ES_USERNAME
        - name: HERMES_ES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hermes-es-api
              key: HERMES_ES_PASSWORD
        - name: HERMES_OS_AUTH_URL
          value: "{{.Values.hermes.auth_url}}"
        - name: HERMES_OS_USERNAME
          value: "{{.Values.hermes.username}}"
        - name: HERMES_OS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hermes-api
              key: HERMES_OS_PASSWORD
        - name: HERMES_API_LISTEN_ADDRESS
          value: "0.0.0.0:80"
        - name: HERMES_POLICY_FILE_PATH
          value: "/etc/hermes/policy.json"
        volumeMounts:
        - mountPath: /etc/hermes
          name: policy
        resources:
          requests:
            memory: {{required ".Values.resources_requests_memory_api is missing" .Values.resources_requests_memory_api}}
            cpu: {{required ".Values.resources_requests_memory_api is missing" .Values.resources_requests_cpu_api}}
      volumes:
      - name: policy
        configMap:
          name: hermes
---
