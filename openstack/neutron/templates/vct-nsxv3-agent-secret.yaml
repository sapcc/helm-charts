{{- if and (.Capabilities.APIVersions.Has "vcenter-operator.stable.sap.cc/v1") (contains ",nsxv3" .Values.ml2_mechanismdrivers ) }}
apiVersion: vcenter-operator.stable.sap.cc/v1
kind: VCenterTemplate
metadata:
  name: 'neutron-nsxv3-secrets'
options:
  scope: 'cluster'
  jinja2_options:
    variable_start_string: '{='
    variable_end_string: '=}'
    {{- if .Values.nsxv3_managed_service_users }}
    # Match vcsu name
    uses-service-user: nsxt
    {{- end }}
template: |
  {%- set bb = name | replace( "bb", "") | int %}
  {%- set hostname = "nsx-ctl-" + "bb" + ( '%03d' % bb ) + "." + domain %}
  apiVersion: v1
  kind: Secret
  metadata:
    name: neutron-ml2-nsxv3-{= name =}
    labels:
      system: openstack
      type: configuration
      component: neutron
      vcenter: {= host =}
      datacenter: {= availability_zone =}
      vccluster: {= cluster_name =}
      {{- if .Values.nsxv3_managed_service_users }}
      vcenter-operator-secret-version: {= service_user_version | quote =}
      {{- end }}
    {{- if .Values.nsxv3_managed_service_users }}
    annotations:
      uses-service-user: nsxt
    {{- end }}
  data:
    {{- if .Values.nsxv3_managed_service_users }}
    NSXV3_LOGIN_USER: {% filter b64enc %}{= username =}{%- endfilter %}
    NSXV3_LOGIN_PASSWORD: {% filter b64enc %}{= password =}{%- endfilter %}
    {{- else }}
    NSXV3_LOGIN_USER: {% filter b64enc %}osapinsxt{%- endfilter %}
    NSXV3_LOGIN_PASSWORD: {% filter b64enc %}{= "{{ .Values.nsxv3_pw_user }}" | derive_password(hostname) =}{%- endfilter %}
    {{- end }}
    neutron-nsxv3-secrets.conf:{= " " =}
  {%- filter b64enc %}
  [NSXV3]
  {{- if .Values.nsxv3_managed_service_users }}
  nsxv3_login_user = {= username =}
  nsxv3_login_password = {= password =}
  {{- else }}
  nsxv3_login_user = osapinsxt
  nsxv3_login_password = {= "{{ .Values.nsxv3_pw_user }}" | derive_password(hostname) | quote =}
  {{- end }}
  {%- endfilter %}
{{ end }}
