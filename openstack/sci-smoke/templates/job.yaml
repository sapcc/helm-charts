apiVersion: batch/v1
kind: Job
metadata:
  name: sci-smoke-test
  labels:
    app: sci-smoke
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 1800  # Clean up after 30 minutes
  template:
    metadata:
      labels:
        app: sci-smoke
    spec:
      restartPolicy: Never
      containers:
        - name: sci-smoke
          image: "{{required ".Values.global.registry is missing" .Values.global.registry}}/{{ .Values.image }}:{{ .Values.imageTag }}"
          command: ["/bin/sh", "-c"]
          args:
            - |
              /usr/bin/sci-smoke -test.v \
                -verbose="$VERBOSE" \
                -flavor="$FLAVOR" \
                -image="$IMAGE" \
                -boot-from-volume="$BOOT_FROM_VOLUME" \
                -volume-size="$VOLUME_SIZE" \
                -volume-type="$VOLUME_TYPE" \
                -network-cidr="$NETWORK_CIDR" \
                -floating-network="$FLOATING_NETWORK" \
                -floating-subnet="$FLOATING_SUBNET" \
                -availability-zone="$AVAILABILITY_ZONE" \
                -aggregate="$AGGREGATE" \
                -timeout="$TIMEOUT" \
                -cleanup="$CLEANUP" \
                -reuse="$REUSE" \
                -skip-preflight="$SKIP_PREFLIGHT" \
                -skip-connectivity="$SKIP_CONNECTIVITY" \
                -skip-migration="$SKIP_MIGRATION" \
                -skip-cold-migration="$SKIP_COLD_MIGRATION" \
                -skip-live-migration="$SKIP_LIVE_MIGRATION" \
                -min-instances="$MIN_INSTANCES" \
                -min-cores="$MIN_CORES" \
                -min-ram="$MIN_RAM" \
                -required-trait="$REQUIRED_TRAIT" \
                -required-trait-strict="$REQUIRED_TRAIT_STRICT" \
                -output-file="$OUTPUT_FILE"
          envFrom:
            - secretRef:
                name: sci-smoke-openstack-credentials
            - configMapRef:
                name: sci-smoke-config
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
