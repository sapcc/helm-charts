apiVersion: batch/v1
kind: Job
metadata:
  name: sci-smoke-test
  labels:
    app: sci-smoke
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 1800  # Clean up after 30 minutes
  template:
    metadata:
      labels:
        app: sci-smoke
    spec:
      restartPolicy: Never
      containers:
        - name: sci-smoke
          image: "{{required ".Values.global.registry is missing" .Values.global.registry}}/{{ .Values.image }}:{{ .Values.imageTag }}"
          command: ["/usr/bin/sci-smoke"]
          args:
            - "-test.v"
            - "--config=/etc/sci-smoke/config.yaml"
          envFrom:
            - secretRef:
                name: sci-smoke-openstack-credentials
          volumeMounts:
            - name: config
              mountPath: /etc/sci-smoke
              readOnly: true
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
      volumes:
        - name: config
          configMap:
            name: sci-smoke-config
