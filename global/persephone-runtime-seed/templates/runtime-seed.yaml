{{- range $key, $cluster := .Values.persephoneShoots }}
---
apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: {{ $key }}{{ $cluster.landscapeName | substr 0 1 }}
  namespace: garden
spec:
  cloudProfile:
    kind: CloudProfile
    name: openstack
  region: {{ required "missing value for $cluster.region" $cluster.region }}
  credentialsBindingName: openstack-infra-creds-seed
{{- if $cluster.highAvailability.enabled }}
  controlPlane:
    highAvailability:
      failureTolerance:
        type: zone
{{- end }}
{{- if $cluster.seedName }}
  seedName: {{ $cluster.seedName }}
{{- end }}
  provider:
    type: openstack
    infrastructureConfig:
      apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      floatingPoolName: {{ $cluster.floatingPoolName }}
      networks:
        workers: 10.180.25.0/24 # should match CNI CIDR
    controlPlaneConfig:
      apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      loadBalancerProvider: f5
    workers: {{ toYaml $cluster.workers | nindent 6 }}
  networking:
    pods: 10.44.0.0/16
    services: 10.45.0.0/16
    nodes: 10.180.25.0/24 # should match infrastructure CIDR
    type: calico
  kubernetes:
    version: {{ required "missing value for $cluster.kubernetes.version" $cluster.kubernetes.version }}
{{- if $cluster.oidcConfig.enabled }}
    kubeAPIServer:
      enableAnonymousAuthentication: true
      structuredAuthentication:
        configMapName: authentication-{{ $key }}{{ $cluster.landscapeName | substr 0 1 }}
{{- end }}
    verticalPodAutoscaler:
      enabled: {{ $cluster.kubernetes.verticalPodAutoscaler.enabled }}
  maintenance:
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
{{- end }}
