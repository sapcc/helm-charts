apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: route-aci-correlator
  labels:
    alertmanager: {{ include "alertmanagerRelease.name" . }}
spec:
  route:
    # Applies ONLY to AutomationGroup alerts
    receiver: aci_correlator_prod
    matchers:
      - name: aci_obs_group
        matchType: "="
        value: "AutomationGroup"
    routes:
      # QA specific routing
      - receiver: aci_correlator_qa
        continue: false
        matchers:
          - name: region
            matchType: "="
            value: qa-de-1

  receivers:
    - name: aci_correlator_qa
      webhookConfigs:
        - sendResolved: true
          urlSecret:
            name: alertmanager-{{ include "alertmanagerRelease.name" . }}-aci-correlator-secrets
            key: qa_url

    - name: aci_correlator_prod
      webhookConfigs:
        - sendResolved: true
          urlSecret:
            name: alertmanager-{{ include "alertmanagerRelease.name" . }}-aci-correlator-secrets
            key: prod_url
---
kind: Secret
apiVersion: v1
type: Opaque
metadata:
  name: alertmanager-{{ include "alertmanagerRelease.name" . }}-aci-correlator-secrets
  labels:
    alertmanager: {{ include "alertmanagerRelease.name" . }}
data:
  qa_url: {{ required ".Values.aciCorrelator.qaWebhookURL undefined" .Values.aciCorrelator.qaWebhookURL | b64enc | quote }}
  prod_url: {{ required ".Values.aciCorrelator.prodWebhookURL undefined" .Values.aciCorrelator.prodWebhookURL | b64enc | quote }}
