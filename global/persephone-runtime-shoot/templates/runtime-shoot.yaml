apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: prt-{{ template "persephone.landscape.short" . }}-{{ required "missing value for .Values.global.region" .Values.global.region }}
spec:
  cloudProfile:
    kind: CloudProfile
    name: openstack
  region: {{ required "missing value for .Values.global.region" .Values.global.region }}
  credentialsBindingName: openstack-infra-creds
{{- if .Values.highAvailability.enabled }}
  controlPlane:
    highAvailability:
      failureTolerance:
        type: zone
{{- end }}
{{- if .Values.seedName }}
  seedName: {{ .Values.seedName }}
{{- end }}
  provider:
    type: openstack
    infrastructureConfig:
      apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      floatingPoolName: {{ .Values.floatingPoolName }}
      networks:
        workers: 10.180.24.0/24 # should match CNI CIDR
    controlPlaneConfig:
      apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      loadBalancerProvider: f5
    workers: {{ toYaml .Values.workers | nindent 6 }}
  networking:
    pods: 10.44.0.0/16
    services: 10.45.0.0/16
    nodes: 10.180.24.0/24 # should match infrastructure CIDR
    type: calico
  kubernetes:
    version: {{ required "missing value for .Values.kubernetes.version" .Values.kubernetes.version }}
{{- if .Values.oidcConfig.enabled }}
    kubeAPIServer:
      enableAnonymousAuthentication: true
      structuredAuthentication:
        configMapName: authentication
{{- end }}
    verticalPodAutoscaler:
      enabled: {{ .Values.kubernetes.verticalPodAutoscaler.enabled }}
  maintenance:
    autoUpdate:
      kubernetesVersion: false
      machineImageVersion: false
