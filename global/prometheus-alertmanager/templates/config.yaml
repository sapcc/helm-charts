apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alertmanager

data:
  alertmanager.yml: |
    global:
      resolve_timeout: 16m

    templates: 
      - ./*.tmpl

    inhibit_rules:
    # Mute warnings for which also a critical alert exists.
    # Per context and region.
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['context']
    - source_match:
        severity: 'critical|warning'
      target_match:
        severity: 'info'
      equal: ['context']

    route:
      group_by: ['region', 'alertname']
      group_wait: 1m
      group_interval: 7m
      repeat_interval: 12h
      receiver: dev-null

      routes:
      - receiver: dev-null
        continue: false
        match_re:
          region: .*staging|lab

      - receiver: slack_by_tier_and_severity
        continue: true
        match_re:
          tier: openstack|kubernetes|kubernikus|baremetal
          severity: info|warning|critical
          region: qa-de-1|ap-ae-1|ap-au-1|ap-cn-1|ap-jp-1|ap-jp-2|ap-sa-1|eu-de-1|eu-de-2|eu-nl-1|eu-ru-1|la-br-1|na-ca-1|na-us-1|na-us-3|k-qa-de-1|k-ap-ae-1|k-ap-au-1|k-ap-cn-1|k-ap-jp-1|k-ap-jp-2|k-ap-sa-1|k-eu-de-1|k-eu-de-2|k-eu-nl-1|k-eu-ru-1|k-la-br-1|k-na-ca-1|k-na-us-1|k-na-us-3

      - receiver: slack_by_tier_and_service
        continue: true
        match_re:
          tier: openstack
          severity: info|warning|critical
          service: arc|backup|barbican|cinder|cfm|designate|elektra|elk|ironic|keystone|limes|lyra|maia|manila|neutron|nova|swift

      - receiver: dev-null
        continue: false
        match_re:
          alertname: RegionalInterconnect.*

      - receiver: pagerduty_baremetal
        continue: false
        match_re:
          severity: critical
          region: ap-ae-1|ap-au-1|ap-cn-1|ap-jp-1|ap-jp-2|ap-sa-1|eu-de-1|eu-de-2|eu-nl-1|eu-ru-1|la-br-1|na-ca-1|na-us-1|na-us-3
          tier: baremetal

      - receiver: pagerduty_hypervisor
        continue: false
        match_re:
          severity: critical
          region: ap-ae-1|ap-au-1|ap-cn-1|ap-jp-1|ap-jp-2|ap-sa-1|eu-de-1|eu-de-2|eu-nl-1|eu-ru-1|la-br-1|na-ca-1|na-us-1|na-us-3
          service: vcenter

      - receiver: pagerduty
        match_re:
          severity: critical
          region: ap-ae-1|ap-au-1|ap-cn-1|ap-jp-1|ap-jp-2|ap-sa-1|eu-de-1|eu-de-2|eu-nl-1|eu-ru-1|la-br-1|na-ca-1|na-us-1|na-us-3
          tier: openstack|kubernetes

      - receiver: pagerduty
        match_re:
          severity: warning
          region: ap-ae-1|ap-au-1|ap-cn-1|ap-jp-1|ap-jp-2|ap-sa-1|eu-de-1|eu-de-2|eu-nl-1|eu-ru-1|la-br-1|na-ca-1|na-us-1|na-us-3
          alertname: KubernetesNodeBond.*|KubernetesNodeNotReady

    receivers:
    - name: dev-null
      slack_configs:
        - api_url: {{ default "MISSING" $.Values.slack.devnull_webhook_url | quote }}
          username: "Control Plane"
          channel: "#dev-null"
          title: {{"'{{template \"slack.sapcc.title\" . }}'"}}
          title_link: {{"'{{template \"slack.sapcc.titlelink\" . }}'"}}
          text: {{"'{{template \"slack.sapcc.text\" . }}'"}}
          pretext: {{"'{{template \"slack.sapcc.pretext\" . }}'"}}
          icon_emoji: {{"'{{template \"slack.sapcc.iconemoji\" . }}'"}}
          send_resolved: true
          actions:
            - name: {{"'{{template \"slack.sapcc.actionname\" . }}'"}}
              type: {{"'{{template \"slack.sapcc.actiontype\" . }}'"}}
              text: {{"'{{template \"slack.sapcc.silence8h.actiontext\" . }}'"}}
              value: {{"'{{template \"slack.sapcc.silence8h.actionvalue\" . }}'"}}
            - name: {{"'{{template \"slack.sapcc.actionname\" . }}'"}}
              type: {{"'{{template \"slack.sapcc.actiontype\" . }}'"}}
              text: {{"'{{template \"slack.sapcc.silence7d.actiontext\" . }}'"}}
              value: {{"'{{template \"slack.sapcc.silence7d.actionvalue\" . }}'"}}
            - name: {{"'{{template \"slack.sapcc.actionname\" . }}'"}}
              type: {{"'{{template \"slack.sapcc.actiontype\" . }}'"}}
              text: {{"'{{template \"slack.sapcc.silence1month.actiontext\" . }}'"}}
              value: {{"'{{template \"slack.sapcc.silence1month.actionvalue\" . }}'"}}

    - name: slack_by_tier_and_severity
      slack_configs:
        - channel: '#{{"{{ .CommonLabels.tier }}"}}-{{"{{ .CommonLabels.severity }}"}}'
          api_url: {{ default "MISSING" .Values.slack.webhook_url | quote }}
          username: "Control Plane"
          title: {{"'{{template \"slack.sapcc.title\" . }}'"}}
          title_link: {{"'{{template \"slack.sapcc.titlelink\" . }}'"}}
          text: {{"'{{template \"slack.sapcc.text\" . }}'"}}
          pretext: {{"'{{template \"slack.sapcc.pretext\" . }}'"}}
          icon_emoji: {{"'{{template \"slack.sapcc.iconemoji\" . }}'"}}
          send_resolved: true

    - name: slack_by_tier_and_service
      slack_configs:
        - channel: '#{{"{{ .CommonLabels.tier }}"}}-{{"{{ .CommonLabels.service }}"}}'
          api_url: {{ default "MISSING" .Values.slack.webhook_url | quote }}
          username: "Control Plane"
          title: {{"'{{template \"slack.sapcc.title\" . }}'"}}
          title_link: {{"'{{template \"slack.sapcc.titlelink\" . }}'"}}
          text: {{"'{{template \"slack.sapcc.text\" . }}'"}}
          pretext: {{"'{{template \"slack.sapcc.pretext\" . }}'"}}
          icon_emoji: {{"'{{template \"slack.sapcc.iconemoji\" . }}'"}}
          send_resolved: true

    - name: pagerduty
      pagerduty_configs:
        - service_key: {{ default "MISSING" .Values.pagerduty.default.service_key | quote }}
          description: {{"'{{ template \"pagerduty.sapcc.description\" . }}'"}}
          component: {{"'{{template \"pagerduty.sapcc.tier\" . }}'"}}
          group: {{"'{{template \"pagerduty.sapcc.service\" . }}'"}}
          details:
            Details: {{"'{{template \"pagerduty.sapcc.details\" . }}'"}}
            Region: {{"'{{template \"pagerduty.sapcc.region\" . }}'"}}
            Tier: {{"'{{template \"pagerduty.sapcc.tier\" . }}'"}}
            Service: {{"'{{template \"pagerduty.sapcc.service\" . }}'"}}
            Context: {{"'{{template \"pagerduty.sapcc.context\" . }}'"}}
            Prometheus: {{"'{{template \"pagerduty.sapcc.prometheus\" . }}'"}}
            Dashboard: {{"'{{template \"pagerduty.sapcc.dashboard\" . }}'"}}
            Sentry: {{"'{{template \"pagerduty.sapcc.sentry\" . }}'"}}
            Playbook: {{"'{{template \"pagerduty.sapcc.playbook\" . }}'"}}
            firing: {{"'{{ template \"pagerduty.sapcc.firing\" . }}'"}}

    - name: pagerduty_baremetal
      pagerduty_configs:
        - service_key: {{ default "MISSING" .Values.pagerduty.baremetal.service_key | quote }}
          description: {{"'{{ template \"pagerduty.sapcc.description\" . }}'"}}
          component: {{"'{{template \"pagerduty.sapcc.tier\" . }}'"}}
          group: {{"'{{template \"pagerduty.sapcc.service\" . }}'"}}
          details:
            Details: {{"'{{template \"pagerduty.sapcc.details\" . }}'"}}
            Region: {{"'{{template \"pagerduty.sapcc.region\" . }}'"}}
            Tier: {{"'{{template \"pagerduty.sapcc.tier\" . }}'"}}
            Service: {{"'{{template \"pagerduty.sapcc.service\" . }}'"}}
            Context: {{"'{{template \"pagerduty.sapcc.context\" . }}'"}}
            Prometheus: {{"'{{template \"pagerduty.sapcc.prometheus\" . }}'"}}
            Dashboard: {{"'{{template \"pagerduty.sapcc.dashboard\" . }}'"}}
            Sentry: {{"'{{template \"pagerduty.sapcc.sentry\" . }}'"}}
            Playbook: {{"'{{template \"pagerduty.sapcc.playbook\" . }}'"}}
            firing: {{"'{{ template \"pagerduty.sapcc.firing\" . }}'"}}

    - name: pagerduty_hypervisor
      pagerduty_configs:
        - service_key: {{ default "MISSING" .Values.pagerduty.hypervisor.service_key | quote }}
          description: {{"'{{ template \"pagerduty.sapcc.description\" . }}'"}}
          component: {{"'{{template \"pagerduty.sapcc.tier\" . }}'"}}
          group: {{"'{{template \"pagerduty.sapcc.service\" . }}'"}}
          details:
            Details: {{"'{{template \"pagerduty.sapcc.details\" . }}'"}}
            Region: {{"'{{template \"pagerduty.sapcc.region\" . }}'"}}
            Tier: {{"'{{template \"pagerduty.sapcc.tier\" . }}'"}}
            Service: {{"'{{template \"pagerduty.sapcc.service\" . }}'"}}
            Context: {{"'{{template \"pagerduty.sapcc.context\" . }}'"}}
            Prometheus: {{"'{{template \"pagerduty.sapcc.prometheus\" . }}'"}}
            Dashboard: {{"'{{template \"pagerduty.sapcc.dashboard\" . }}'"}}
            Sentry: {{"'{{template \"pagerduty.sapcc.sentry\" . }}'"}}
            Playbook: {{"'{{template \"pagerduty.sapcc.playbook\" . }}'"}}
            firing: {{"'{{ template \"pagerduty.sapcc.firing\" . }}'"}}

  {{- $files := .Files }}
  {{ range tuple "slack.tmpl" "pagerduty.tmpl" }}
  {{ . }}: |
{{ $files.Get . | indent 4 }}
  {{- end }}
