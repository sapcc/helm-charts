groups:
  - name: kube-state-metrics-normalization.rules
    rules:
      - record: kube_node_info_normalized
        expr: max by(cluster, region, cluster_type, container_runtime_version, kernel_version, kubelet_version, kubeproxy_version, node, os_image) (kube_node_info)

      - record: kube_pod_info_normalized
        expr: max by (region, cluster, cluster_type, namespace, pod, node) (kube_pod_info)

        # Join the node name to the kube_pod_info metric.
      - record: kube_pod_status_ready_normalized
        expr: max by(region, cluster, cluster_type, namespace, pod, node) (kube_pod_info) * on(pod) group_left(condition) max by (pod, condition) (kube_pod_status_ready == 1)

      - record: kube_pod_container_resource_requests_memory_bytes_average
        expr: |
            avg(
                count_over_time(kube_pod_container_resource_requests_memory_bytes{container!="",container!="POD", node!=""}[5m])
                *
                avg_over_time(kube_pod_container_resource_requests_memory_bytes{container!="",container!="POD", node!=""}[5m])
            ) by (namespace, container, pod, node, cluster)

      - record: kube_pod_container_resource_requests_cpu_cores_average
        expr: |
            avg(
                count_over_time(kube_pod_container_resource_requests_cpu_cores{container!="",container!="POD", node!=""}[5m])
                *
                avg_over_time(kube_pod_container_resource_requests_cpu_cores{container!="",container!="POD", node!=""}[5m])
            ) by (namespace, container, pod, node, cluster)

      - record: kube_persistentvolumeclaim_resource_requests_storage_bytes_average
        expr: |
            avg(kube_persistentvolumeclaim_info) by (persistentvolumeclaim, storageclass, namespace, volumename, cluster)
            *
            on (persistentvolumeclaim, namespace, cluster) group_right(storageclass, volumename)
            sum(kube_persistentvolumeclaim_resource_requests_storage_bytes) by (persistentvolumeclaim, namespace, cluster)
