groups:
- name: netapp-filer-capacity
  rules:
  - record: global:netapp_filer_total_bytes
    expr: sum by (app, region, filer, availability_zone) (netapp_aggregate_total_bytes{app=~".*cinder|.*manila"})
  - record: global:netapp_filer_used_bytes
    expr: sum by (app, region, filer, availability_zone) (netapp_aggregate_used_bytes{app=~".*cinder|.*manila"})
  - record: global:netapp_filer_available_bytes
    expr: sum by (app, region, filer, availability_zone) (netapp_aggregate_available_bytes{app=~".*cinder|.*manila"})
  - record: netapp_aggregate_unencrypted_total:manila
    expr: count (netapp_aggregate_is_encrypted{app=~".*manila"}==0)
  - record: netapp_aggregate_encrypted_total:manila
    expr: count (netapp_aggregate_is_encrypted{app=~".*manila"}==1)
  - record: global:netapp_volume_unencrypted_total:manila
    expr: count by (filer) (netapp_volume_is_encrypted{app=~".*manila"}==0)
  - record: global:netapp_volume_encrypted_total:manila
    expr: count by (filer) (netapp_volume_is_encrypted{app=~".*manila"}==1)

  - record: netapp_aggregate_total_bytes:vpod:small
    expr: netapp_aggregate_total_bytes{app=~".*cinder"} <= 20*1024*1024*1024*1024

  - record: netapp_aggregate_total_bytes:vpod:big
    expr: netapp_aggregate_total_bytes{app=~".*cinder"} > 20*1024*1024*1024*1024

  - record: netapp_aggregate_used_bytes:vpod:small
    expr: netapp_aggregate_used_bytes * netapp_aggregate_total_bytes / on (aggregate, availability_zone, filer, node) netapp_aggregate_total_bytes:vpod:small

  - record: netapp_aggregate_used_bytes:vpod:big
    expr: netapp_aggregate_used_bytes * netapp_aggregate_total_bytes / on (aggregate, availability_zone, filer, node) netapp_aggregate_total_bytes:vpod:big

  - record: netapp_aggregate_used_percentage:vpod:small
    expr: netapp_aggregate_used_percentage * netapp_aggregate_total_bytes / on (aggregate, availability_zone, filer, node) netapp_aggregate_total_bytes:vpod:small

  - record: netapp_aggregate_used_percentage:vpod:big
    expr: netapp_aggregate_used_percentage * netapp_aggregate_total_bytes / on (aggregate, availability_zone, filer, node) netapp_aggregate_total_bytes:vpod:big

  # metrics for maia

  - record: netapp_volume_total_bytes:maia
    expr: netapp_volume_total_bytes{app="netapp-capacity-exporter-manila"}

  # use logical used bytes when logical space reporting is enabled
  - record: netapp_volume_used_bytes:maia
    expr: (netapp_volume_logical_used_bytes{app="netapp-capacity-exporter-manila"} and (netapp_volume_is_space_reporting_logical == 1) and (netapp_volume_is_space_enforcement_logical == 1)) or netapp_volume_used_bytes{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_available_bytes:maia
    expr: netapp_volume_available_bytes{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_used_percentage:maia
    expr: round(netapp_volume_used_bytes:maia / netapp_volume_total_bytes * 100)

  - record: netapp_volume_snapshot_reserved_bytes:maia
    expr: netapp_volume_snapshot_reserved_bytes{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_snapshot_used_bytes:maia
    expr: netapp_volume_snapshot_used_bytes{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_snapshot_available_bytes:maia
    expr: netapp_volume_snapshot_available_bytes{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_inode_files_total:maia
    expr: netapp_volume_inode_files_total{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_inode_files_used:maia
    expr: netapp_volume_inode_files_used{app="netapp-capacity-exporter-manila"}

  - record: netapp_volume_inode_files_used_percentage:maia
    expr: netapp_volume_inode_files_used_percentage{app="netapp-capacity-exporter-manila"}
