apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: network-generic-ssh-exporter-aci-leaf
  namespace: infra-monitoring
  labels:
    prometheus: {{ .Values.network_generic_ssh_exporter.prometheus }}
    app.kubernetes.io/name: network-generic-ssh-exporter-aci-leaf
spec:
  httpSDConfigs:
    - url: {{ .Values.global.http_sd_configs.netbox_url }}/devices/?custom_labels=__param_module=asa&status=active&region={{ .Values.global.region }}&tenant=converged-cloud&role=aci-leaf&manufacturer=cisco
      refresh_interval: {{ .Values.global.http_sd_configs.refresh_interval }}
  metricsPath: /snmp
  relabelings:
    - sourceLabels: [__address__]
      targetLabel: __param_target
    - sourceLabels: [__param_target]
      targetLabel: instance
    - targetLabel: __address__
      replacement: snmp-exporter:{{.Values.snmp_exporter.listen_port}}
  metricRelabelings:
    - sourceLabels: [name]
      targetLabel:  devicename
    - sourceLabels: [devicename]
      regex: '(\w*-\w*-\w*)-(\S*)'
      replacement: '$1'
      targetLabel: availability_zone
    - sourceLabels: [devicename]
      regex: '(\w*-\w*-\w*)-(\S*)'
      replacement: '$2'
      targetLabel: device
    - sourceLabels: [__name__, snmp_asa_sysDescr]
      regex: 'snmp_asa_sysDescr;([a-zA-Z ]*)([0-9().]*)'
      replacement: '$2'
      targetLabel: image_version
    - sourceLabels: [__name__, device]
      regex: 'snmp_asa_sysDescr;(ASA0102-CC-CORP|AsSA0102-CC-DMZ|ASA0102-CC-HEC|ASA0102-CC-INTERNET|ASA0102-CC-SAAS|ASA0102a-CC-HEC|ASA0102a-CC-DMZ|ASA0102a-CC-CORP|ASA0102a-CC-INTERNET|ASA0102a-CC-SAAS)'
      action: drop
