{{- if .Values.enabled }}
{{- $region := required ".Values.global.region is required" .Values.global.region }}
{{- $interfaceFilter := printf "%s, region: \"%s\"" .Values.env.INTERFACE_BASE_FILTER $region }}
{{- $deviceFilter := printf "%s, region: \"%s\"" .Values.env.DEVICE_BASE_FILTER $region }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.fullname }}-config
  labels:
    app.kubernetes.io/name: {{ .Values.fullname }}
    app.kubernetes.io/instance: {{ .Release.Name }}
data:
  # Render a full /app/env.yml from the provided .Values.env (uppercase keys)
  env.yml: |-
    flask_host: {{ .Values.env.FLASK_HOST | quote }}
    flask_port: {{ .Values.env.FLASK_PORT | int }}
    flask_debug: {{ .Values.env.FLASK_DEBUG | lower }}

    log_level: {{ .Values.env.LOG_LEVEL | quote }}
    log_file: {{ .Values.env.LOG_FILE | quote }}

    netbox_url: {{ .Values.env.NETBOX_URL | quote }}
    netbox_retry_attempts: {{ .Values.env.NETBOX_RETRY_ATTEMPTS | int }}
    netbox_retry_delay_seconds: {{ .Values.env.NETBOX_RETRY_DELAY_SECONDS | int }}
    netbox_request_timeout_seconds: {{ .Values.env.NETBOX_REQUEST_TIMEOUT_SECONDS | int }}

    cache_host: {{ .Values.env.CACHE_HOST | quote }}
    cache_port: {{ .Values.env.CACHE_PORT | int }}
    cache_timeout: {{ .Values.env.CACHE_TIMEOUT | int }}
    cache_prefix: {{ .Values.env.CACHE_PREFIX | quote }}
    cache_retry_attempts: {{ .Values.env.CACHE_RETRY_ATTEMPTS | int }}
    cache_retry_delay_seconds: {{ .Values.env.CACHE_RETRY_DELAY_SECONDS | int }}
    cache_ttl_seconds: {{ .Values.env.CACHE_TTL_SECONDS | int }}
    batch_size: {{ .Values.env.BATCH_SIZE | int }}
    refresh_interval_seconds: {{ .Values.env.REFRESH_INTERVAL_SECONDS | int }}
    since_hours_on_hit: {{ .Values.env.SINCE_HOURS_ON_HIT | int }}
    save_aggregate_connections: {{ .Values.env.SAVE_AGGREGATE_CONNECTIONS | lower }}

    interface_base_filter: {{ $interfaceFilter | quote }}
    device_base_filter: {{ $deviceFilter | quote }}
    debug_refresh: {{ .Values.env.DEBUG_REFRESH | lower }}

  # Keep uppercase envs too (backward compatible, in case you use envFrom in the future)
  {{- range $k, $v := .Values.env }}
  {{ $k }}: {{ $v | quote }}
  {{- end }}
{{- end }}
