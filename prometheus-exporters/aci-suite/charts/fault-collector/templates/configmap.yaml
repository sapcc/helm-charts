{{- if .Values.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fault-collector.fullname" . }}-config
  labels:
    {{- include "fault-collector.labels" . | nindent 4 }}
data:
  env.yml: |-
    # the id to store keys for
    aci_id: {{ .Values.env.aci_id | quote }}

    # The apic servers
    {{- $apicHosts := required "missing $.Values.aci.apic_hosts" $.Values.aci.apic_hosts }}
    apic_servers:
    {{- range $s := $apicHosts }}
      - {{ $s | quote }}
    {{- end }}

    # Request timeout parameters
    apic_reset_timeout: {{ .Values.env.apic_reset_timeout | int }}
    apic_cookie_timeout: {{ .Values.env.apic_cookie_timeout | int }}
    apic_request_timeout: {{ .Values.env.apic_request_timeout | int }}
    apic_login_failed_timeout: {{ .Values.env.apic_login_failed_timeout | int }}

    # websocker parameters
    apic_ws_subscribe_interval: {{ .Values.env.apic_ws_subscribe_interval | int }}
    apic_ws_message_process_interval: {{ .Values.env.apic_ws_message_process_interval | int }}
    apic_ws_message_cache_error_counter: {{ .Values.env.apic_ws_message_cache_error_counter | int }}
    apic_ws_service_restart_interval: {{ .Values.env.apic_ws_service_restart_interval | int }}

    # cache connection (password from env)
    cache_host: {{ .Values.env.cache_host | quote }}
    cache_port: {{ .Values.env.cache_port | int }}
    cache_timeout: {{ .Values.env.cache_timeout | int }}
    cache_max_delay: {{ .Values.env.cache_max_delay | int }}
    cache_max_retries: {{ .Values.env.cache_max_retries | int }}

    collectors:
    {{- range $name, $cfg := .Values.env.collectors }}
      {{ $name }}:
      {{- if $cfg }}
{{ toYaml $cfg | nindent 8 }}
      {{- else }}
        {}
      {{- end }}
    {{- end }}

    log_level: {{ .Values.env.log_level | quote }}
    verify_ssl: {{ .Values.env.verify_ssl | toYaml | trim }}
{{- end }}
