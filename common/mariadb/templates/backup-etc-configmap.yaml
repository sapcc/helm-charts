{{- if .Values.backup_v2.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name:  mariadb-backup-{{.Values.name}}-etc
  labels:
    app: mariadb
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    component: database
data:
  config.yaml: |
    namespace: {{ .Release.Namespace }}
    service_name: {{ .Values.name }}
    sidecar: false
    backup:
      full_backup_cron_schedule: {{ .Values.backup_v2.full_backup_cron_schedule }}
      incremental_backup_in_minutes: {{ .Values.backup_v2.incremental_backup_in_minutes }}
      backup_dir: {{ .Values.backup_v2.backup_dir }}
      enable_init_restore: {{ .Values.backup_v2.enable_init_restore }}
      oauth:
        enabled: {{ default true .Values.backup_v2.oauth.enabled}}
        provider_url: "https://auth.mariabackup.{{ .Values.global.region }}.cloud.sap"
        redirect_url: "https://{{ .Values.name }}.mariabackup.{{ .Values.global.region }}.cloud.sap"
    database:
      type: "mariadb"
      user: root
      version: {{ .Values.backup_v2.maria_db.version }}
      password: {{ include "mariadb.root_password" . }}
      host: {{ include "fullName" . }}
      port: 3306
      server_id: 999
      data_dir: /var/lib/mysql
      log_name_format: mysqld-bin
      databases:
      {{- range $db := .Values.backup_v2.databases }}
        - "{{$db}}"
      {{- end }}
      verify_tables:
      {{- range $tl := .Values.backup_v2.verify_tables }}
        - "{{$tl}}"
      {{- end }}
    storages:
      s3:
        - name: aws-{{ .Values.global.mariadb.backup_v2.aws.region }}
          aws_access_key_id: {{ .Values.global.backup_v2.aws_access_key_id }}
          aws_secret_access_key: {{ .Values.global.backup_v2.aws_secret_access_key }}
          region: {{ .Values.global.mariadb.backup_v2.aws.region }}
          bucket_name: "mariadb-backup-{{ .Values.global.region }}"
          sse_customer_algorithm: "AES256"
          sse_customer_key: "{{ .Values.global.mariadb.backup_v2.aws.sse_customer_key }}"
      swift:
        - name: swift-{{ .Values.global.region }}
          auth_version: 3
          auth_url:  https://identity-3.{{ .Values.global.region }}.cloud.sap/v3
          user_name: db_backup
          user_domain_name: Default
          project_name: master
          project_domain_name: ccadmin
          password: {{ .Values.backup_v2.swift.password | default .Values.global.dbBackupServicePassword | required "Please set Values.global.dbBackupServicePassword or .Values.backup.os_password" | quote }}
          region: {{ .Values.global.region }}
          container_name: "mariadb-backup-{{ .Values.global.region }}"
    verification:
      interval_in_minutes: {{ .Values.backup_v2.verification_interval }}
{{- end }}
