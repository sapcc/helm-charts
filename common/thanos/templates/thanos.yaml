apiVersion: monitoring.banzaicloud.io/v1alpha1
kind: Thanos
metadata:
  name: {{ include "thanos.fullName" . }}
spec:
  {{- if not .Values.thanos.deployWholeThanos }}
  queryDiscovery: true
  {{- end }}
  clusterDomain: kubernetes.{{ required ".Values.global.region missing" .Values.global.region }}.{{ required ".Values.global.domain missing" .Values.global.domain }}
  query:
    logLevel: {{ .Values.thanos.logLevel }}
    queryAutoDownsampling: true
    queryReplicaLabel:
      - prometheus_replica
    {{- if .Values.thanos.deployWholeThanos }}
    webRoutePrefix: {{ required ".Values.thanos.query.webRouteprefix missing" .Values.thanos.query.webRouteprefix }}
    webExternalPrefix: {{ required ".Values.thanos.query.webRouteprefix missing" .Values.thanos.query.webRouteprefix }}
    {{- end }}
    {{- if or .Values.thanos.deployWholeThanos .Values.thanos.query.stores }}
    stores:
    {{- end }}
    {{- if .Values.thanos.query.stores }}
      {{- range $store := .Values.thanos.query.stores }}
      - {{ $store }}
      {{- end }}
    {{- else }}
      - prometheus-{{ required ".Values.name missing" .Values.name }}:10901
    {{- end }}
    deploymentOverrides:
      spec:
        template:
          spec:
            containers:
            - image: {{ include "thanosimage" . }}
              name: query
  {{- if .Values.thanos.deployWholeThanos }}
  storeGateway:
    logLevel: {{ .Values.thanos.logLevel }}
    indexCacheSize: {{ required ".Values.thanos.store.indexCacheSize missing" .Values.thanos.store.indexCacheSize }}
    chunkPoolSize: {{ required ".Values.thanos.store.chunkPoolSize missing" .Values.thanos.store.chunkPoolSize }}
    storeGRPCSeriesMaxConcurrency: {{ required ".Values.thanos.store.seriesMaxConcurrency missing" .Values.thanos.store.seriesMaxConcurrency }}
    deploymentOverrides:
      spec:
        template:
          spec:
            containers:
            - image: {{ include "thanosimage" . }}
              name: store
  {{- end }}
