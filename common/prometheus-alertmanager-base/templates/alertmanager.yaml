apiVersion: monitoring.coreos.com/v1
kind: Alertmanager

metadata:
  name: {{ include "alertmanager.name" . }}
  labels:
    app: prometheus-alertmanager
    alertmanager: {{ include "alertmanager.name" . }}

spec:
  replicas: {{ required ".Values.replicas missing" .Values.replicas }}

  image: {{ include "alertmanager.image" . }}

  version: {{ default (required ".Chart.AppVersion missing" .Chart.AppVersion) .Values.version }} 

  logLevel: {{ required ".Values.logLevel missing" .Values.logLevel }}

  # The retention time of the Alertmanager.
  # Can only use s/m/h as unit. 168h = 7d.
  retention: {{ required ".Values.retention missing" .Values.retention }}

  forceEnableClusterMode: {{ required ".Values.forceEnableClusterMode missing" .Values.forceEnableClusterMode }}

  alertmanagerConfigSelector:
    matchLabels:
      alertmanager: {{ include "alertmanager.name" . }}

  alertmanagerConfigMatcherStrategy:
    type: {{ .Values.alertmanagerConfigMatcherStrategy }}

  # AdditionalPeers allows injecting a set of additional Alertmanagers to peer with to form a highly available cluster.
  {{ if .Values.additionalPeers -}}
  additionalPeers:
{{ toYaml .Values.additionalPeers | indent 2 }}
  {{- end }}

  # ClusterAdvertiseAddress is the explicit address to advertise in cluster.
  {{ if .Values.clusterAdvertiseAddress -}}
  clusterAdvertiseAddress: {{ .Values.clusterAdvertiseAddress }}
  {{- end }}

  # if AMs need to gossip they won't, unless the clusterLabel is identical. This is autogenerated since v0.26.0 to different labels. 
  {{ if .Values.clusterLabel -}}
  clusterLabel: {{ .Values.clusterLabel }}
  {{- end }}

  # Mount additional configmaps from the same namespace.
  {{ if .Values.configMaps -}}
  configMaps:
{{ toYaml .Values.configMaps | indent 4 }}
  {{- end }}

  {{ if .Values.secrets -}}
  # Mount additional secrets from the same namespace.
  secrets:
{{ toYaml .Values.secrets | indent 4 }}
  {{- end }}

  {{ if .Values.notificationTemplates.defaultEnabled -}}
  # Additional volumes for the Alertmanager Pod.
  volumes:
    - name: {{ include "alertmanager.fullname" . }}-notification-templates
      configMap:
        name: {{ include "alertmanager.fullname" . }}-notification-templates

  # Additional volume mounts for the Alermanager Pod.
  volumeMounts:
    - name: {{ include "alertmanager.fullname" . }}-notification-templates
      mountPath: /notification-templates
      readOnly: true
  {{- end }}

  {{ if .Values.resources -}}
  # Kubernetes resource requests and limits for this Alertmanager.
  # See: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container .
  resources:
{{ toYaml .Values.resources | indent 4 }}
  {{- end }}

  # Storage configuration.
  # If configured, persistent storage is used, alternatively data is stored in memory.
  storage:
    {{- if .Values.persistence.enabled }}
    volumeClaimTemplate:
      metadata:
        name: {{ include "pvc.name" . }}
        labels:
          alertmanager: {{ include "alertmanager.name" . }}
      spec:
        accessModes:
{{ required ".Values.persistence.accessModes missing" .Values.persistence.accessModes | toYaml | indent 10 }}
        resources:
          requests:
            storage: {{ required ".Values.persistence.size missing" .Values.persistence.size | quote }}
        {{ if .Values.persistence.selector }}
        selector:
{{ toYaml .Values.persistence.selector | indent 10 }}
        {{ end }}
    {{ else }}
    emptyDir:
      medium: Memory
    {{- end -}}

  {{- if or .Values.ingress.host .Values.ingress.hostNameOverride -}}
  # The external URL of the Alertmanager.
  externalUrl: https://{{ include "alertmanager.externalURL" . }}
  {{- end }}

  {{- if .Values.securityContext }}
  # A security context defines privilege and access control settings for a Pod or Container.
  securityContext:
{{ toYaml .Values.securityContext | indent 4 }}
  {{- end }}

  {{- if .Values.tolerations }}
  # The pod tolerations.
  tolerations:
{{ toYaml .Values.tolerations | indent 4 }}
  {{- end }}

  {{- if .Values.nodeSelector }}
  # Define which Nodes the Pods are scheduled on.
  nodeSelector:
{{ toYaml .Values.nodeSelector | indent 4 }}
  {{- end }}

  {{- if .Values.affinity }}
  # Assign custom affinity rules to the Alertmanager instance.
  affinity:
{{ toYaml .Values.affinity | indent 4 }}
  {{- end }}
