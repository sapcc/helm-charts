kind: Deployment
apiVersion: apps/v1
metadata:
  name: {{ .Release.Name }}-pgmetrics
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
spec:
  replicas: {{ .Values.replicas }}
  revisionHistoryLimit: {{ .Values.upgrades.revisionHistory }}
  strategy:
    type: {{ .Values.upgrades.podReplacementStrategy }}
    {{ if eq .Values.upgrades.podReplacementStrategy "RollingUpdate" }}
    rollingUpdate:
      maxUnavailable: {{ .Values.upgrades.rollingUpdate.maxUnavailable }}
      maxSurge: {{ .Values.upgrades.rollingUpdate.maxSurge }}
    {{ end }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}-{{ .Chart.Name }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-{{ .Chart.Name }}
        component: {{ default .Release.Name .Values.db_name }}
        type: metrics
      annotations:
        chart-version: {{.Chart.Version}}
        configmap-etc-hash: {{ include (print $.Template.BasePath "/configmap-etc.yaml") . | sha256sum }}
        # Would be nice to have metrics in Maia as well: maia.io/scrape: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: {{ default 9187 .Values.port | quote }}
        prometheus.io/targets: {{ required ".Values.alerts.prometheus missing" .Values.alerts.prometheus | quote }}
    spec:
      containers:
      - name: metrics
        {{- if contains "." .Values.image }}
        image: "{{ .Values.image }}:{{ .Values.imageTag }}"
        {{- else }}
        image: "{{ required ".Values.global.dockerHubMirror missing" .Values.global.dockerHubMirror }}/{{ .Values.image }}:{{ .Values.imageTag }}"
        {{- end }}
        imagePullPolicy: {{ default "IfNotPresent" .Values.imagePullPolicy | quote }}
        env:
        - name: DATA_SOURCE_NAME
          value: postgresql://{{ .Values.global.dbUser | default "postgres" }}:{{ .Values.db_password | default .Values.global.dbPassword }}@{{include "db_host" .}}:{{ default 5432 .Values.db_port }}/{{ default .Release.Name .Values.db_name}}?sslmode=disable
        ports:
          - name: metrics
            containerPort: {{ default 9187 .Values.port }}
        {{- if .Values.customMetrics }}
        args: ["--extend.query-path", "/conf/custom-metrics.yaml", "--log.level", {{ .Values.log_level }}]
        volumeMounts:
          - name: custom-metrics
            mountPath: /conf
            readOnly: true
        {{- end }}
        {{- if .Values.resources.enabled }}
        resources:
          limits:
            cpu: {{ .Values.resources.limits.cpu | quote }}
            memory: {{ .Values.resources.limits.memory | quote }}
          requests:
            cpu: {{ .Values.resources.requests.cpu | quote }}
            memory: {{ .Values.resources.requests.memory | quote }}
        {{- end }}
      {{- if .Values.dependencyJobs }}
      initContainers:
        - name: init
          image: quay.io/stackanetes/kubernetes-entrypoint:v0.2.1
          imagePullPolicy: {{ default "IfNotPresent" .Values.imagePullPolicy | quote }}
          env:
            - name: DEPENDENCY_JOBS
              value: {{ .Values.dependencyJobs | quote }}
            - name: COMMAND
              value: "echo done"
          command:
            - kubernetes-entrypoint
      {{- end }}
      volumes:
      {{- if .Values.customMetrics }}
      - name: custom-metrics
        configMap:
          name: {{ .Release.Name }}-{{ .Chart.Name }}-etc
          items:
          - key: custom-metrics.yaml
            path: custom-metrics.yaml
      {{- end }}
