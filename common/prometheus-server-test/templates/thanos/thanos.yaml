{{- if .Values.thanos.enabled }}
apiVersion: monitoring.banzaicloud.io/v1alpha1
kind: Thanos
metadata:
  name: {{ include "prometheus.name" . }}-thanos
spec:
  clusterDomain: kubernetes.{{ required ".Values.global.region missing" .Values.global.region }}.{{ required ".Values.global.domain missing" .Values.global.domain }}
  query:
    logLevel: {{ .Values.logLevel }}
    queryAutoDownsampling: true
    queryReplicaLabel:
      - prometheus_replica
    webRoutePrefix: {{ required ".Values.thanos.querier.webRouteprefix missing" .Values.thanos.querier.webRouteprefix }}
    webExternalPrefix: {{ required ".Values.thanos.querier.webRouteprefix missing" .Values.thanos.querier.webRouteprefix }}
    stores:
      # sidecar running in prometheus
      - {{ include "prometheus.fullName" . }}:10901
    deploymentOverrides:
      spec:
        template:
          spec:
            containers:
            - image: {{ required ".Values.thanos.spec.baseImage missing" .Values.thanos.spec.baseImage }}:{{ required ".Values.thanos.spec.version missin" .Values.thanos.spec.version }}
              name: query
  storeGateway:
    logLevel: {{ .Values.logLevel }}
    indexCacheSize: {{ required ".Values.thanos.store.indexCacheSize missing" .Values.thanos.store.indexCacheSize }}
    chunkPoolSize: {{ required ".Values.thanos.store.chunkPoolSize missing" .Values.thanos.store.chunkPoolSize }}
    storeGRPCSeriesMaxConcurrency: {{ required ".Values.thanos.store.seriesMaxConcurrency missing" .Values.thanos.store.seriesMaxConcurrency }}
    deploymentOverrides:
      spec:
        template:
          spec:
            containers:
            - image: {{ required ".Values.thanos.spec.baseImage missing" .Values.thanos.spec.baseImage }}:{{ required ".Values.thanos.spec.version missin" .Values.thanos.spec.version }}
              name: store
{{ end }}
