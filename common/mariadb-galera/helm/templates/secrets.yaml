apiVersion: v1
type:
kind: List
metadata:
  name: {{ include "commonPrefix" $ }}{{ $.Release.Name }}-secrets
  namespace: {{ $.Release.Namespace }}
items:
{{- range $credentialKey, $credentialValue := $.Values.mariadb.users }}
  {{- $requiredUsers := list "root" }}
  {{- if or ($.Values.monitoring.mysqld_exporter.enabled) (and ($.Values.proxy.enabled) (eq $.Values.proxy.type "proxysql")) }}
    {{- $requiredUsers = append $requiredUsers "monitor" }}
    {{- $requiredUsers = $requiredUsers | uniq | compact }}
  {{- end}}
  {{- if or (has $credentialKey $requiredUsers) $credentialValue.enabled }}
    {{- include "generateSecret" (dict "global" $ "name" $credentialKey "credential" $credentialValue "suffix" "mariadb" "kind" "Secret") }}
  {{- end }}
{{- end }}
{{- range $credentialKey, $credentialValue := $.Values.proxy.proxysql.users }}
  {{- if and ($.Values.proxy.enabled) (eq $.Values.proxy.type "proxysql") }}
    {{- if  and ($credentialValue.enabled) }}
      {{- include "generateSecret" (dict "global" $ "name" $credentialKey "credential" $credentialValue "suffix" "proxysql" "kind" "Secret") }}
    {{- end }}
  {{- end }}
{{- end }}
{{- range $credentialKey, $credentialValue := $.Values.proxy.haproxy.users }}
  {{- if and ($.Values.proxy.enabled) (eq $.Values.proxy.type "haproxy") }}
    {{- if  and ($credentialValue.enabled) }}
      {{- include "generateSecret" (dict "global" $ "name" $credentialKey "credential" $credentialValue "suffix" "haproxy" "kind" "Secret") }}
    {{- end }}
  {{- end }}
{{- end }}
{{- range $credentialKey, $credentialValue := $.Values.mariadb.galera.backup.kopia.users }}
  {{- if $credentialValue.enabled }}
    {{- include "generateSecret" (dict "global" $ "name" $credentialKey "credential" $credentialValue "suffix" "kopia" "kind" "Secret") }}
  {{- end }}
{{- end }}
{{- range $credentialKey, $credentialValue := $.Values.image.pullSecrets }}
  {{- if $credentialValue.enabled }}
    {{- include "generateSecret" (dict "global" $ "name" $credentialKey "credential" $credentialValue "kind" "Dockerconfigjson") }}
  {{- end }}
{{- end }}
