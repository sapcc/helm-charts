From b60cbc07384172b3906c969aa12a3070a744cef8 Mon Sep 17 00:00:00 2001
From: Artem Torubarov <torubarov.a.a@gmail.com>
Date: Fri, 14 Jun 2024 11:12:13 +0200
Subject: [PATCH] create default rgw pools

---
 system/cc-ceph/Chart.yaml                     |   2 +-
 .../cc-ceph/templates/default_rgw_pools.yaml  | 128 ++++++++++++++++++
 system/cc-ceph/values.yaml                    |   9 ++
 3 files changed, 138 insertions(+), 1 deletion(-)
 create mode 100644 system/cc-ceph/templates/default_rgw_pools.yaml

diff --git a/system/cc-ceph/Chart.yaml b/system/cc-ceph/Chart.yaml
index 5601330c0..29eee5d43 100644
--- a/system/cc-ceph/Chart.yaml
+++ b/system/cc-ceph/Chart.yaml
@@ -2,7 +2,7 @@ apiVersion: v2
 name: cc-ceph
 description: A Helm chart for the Rook / Ceph Objects inside the Storage Clusters
 type: application
-version: 1.0.52
+version: 1.0.53
 appVersion: "1.14.3"
 dependencies:
   - name: owner-info
diff --git a/system/cc-ceph/templates/default_rgw_pools.yaml b/system/cc-ceph/templates/default_rgw_pools.yaml
new file mode 100644
index 0000000000..4ebb6f40d
--- /dev/null
+++ b/system/cc-ceph/templates/default_rgw_pools.yaml
@@ -0,0 +1,128 @@
+{{- if .Values.defaultRgwPools.enabled }}
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-root
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.root
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "8"
+    pgp_num: "8"
+---
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-control
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.control
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "8"
+    pgp_num: "8"
+---
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-meta
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.meta
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "8"
+    pgp_num: "8"
+---
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-log
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.log
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "32"
+    pgp_num: "32"
+---
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-buckets-index
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.buckets.index
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "8"
+    pgp_num: "8"
+---
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-buckets.data
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.buckets.data
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "8"
+    pgp_num: "8"
+---
+apiVersion: ceph.rook.io/v1
+kind: CephBlockPool
+metadata:
+  name: rgw-buckets-non-ec
+  namespace: {{ .Release.Namespace }}
+spec:
+  name: .rgw.buckets.non-ec
+  failureDomain: {{ .Values.defaultRgwPools.failureDomain | default "host"  }}
+  replicated:
+    size: {{ .Values.defaultRgwPools.replicated }}
+    replicasPerFailureDomain: {{ .Values.defaultRgwPools.replicasPerFailureDomain | default 1 }}
+    subFailureDomain: {{ .Values.defaultRgwPools.subFailureDomain | default "host" }}
+  crushRoot: {{ required ".Values.defaultRgwPools.crushRoot is required!" .Values.defaultRgwPools.crushRoot }} 
+  deviceClass: {{ .Values.defaultRgwPools.deviceClass }}
+  parameters:
+    pg_num: "8"
+    pgp_num: "8"
+{{- end }}
+    
diff --git a/system/cc-ceph/values.yaml b/system/cc-ceph/values.yaml
index af3a1a54a..4ac114b7e 100644
--- a/system/cc-ceph/values.yaml
+++ b/system/cc-ceph/values.yaml
@@ -125,3 +125,12 @@ objectstore:
 
 rgwTargetPlacements:
   enabled: false 
+
+defaultRgwPools:
+  enabled: false # create default rgw pools, see: https://github.com/sapcc/helm-charts/issues/6670
+  crushRoot: "" # required if enabled. should be equal to crush_rule for rgw.buckets.index pool
+  failureDomain: host
+  replicated: 3
+  replicasPerFailureDomain: 1
+  subFailureDomain: host
+  deviceClass: nvme
-- 
2.39.3 (Apple Git-145)

